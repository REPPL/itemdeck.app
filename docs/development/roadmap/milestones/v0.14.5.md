# v0.14.5 - Shared Mechanics Components & Standardisation

## Overview

Extract duplicated patterns from game mechanics into a shared component library, standardise game configuration and presentation, and add JSON-based responsive configuration. This refactor addresses technical debt from v0.14.0 and ensures consistent user experience across all devices.

### Goals

1. **Code Deduplication** - Extract shared UI components from 5 mechanics
2. **Visual Standardisation** - Consistent buttons, labels, and layouts across games
3. **Configuration Standardisation** - Common settings interface for all games
4. **Responsive Configuration** - JSON-based display settings for mobile/tablet/desktop
5. **Deferred Features** - Complete features postponed from earlier milestones

## Problem Statement

After v0.14.0, the codebase has significant code duplication across mechanics:

### Component File Sizes (Post v0.14.0)

| Mechanic | Structure | Total Lines | Issues |
|----------|-----------|-------------|--------|
| **Competing** | Monolithic | 539 lines | Single file, duplicates patterns |
| **Snap-Ranking** | Monolithic | 427 lines | Single file, duplicates patterns |
| **Memory** | Monolithic | 231 lines | Single file, duplicates patterns |
| **Quiz** | Modular (7 files) | 769 lines | Good structure, some duplication |
| **Collection** | Modular (3 files) | 489 lines | Good structure, minimal duplication |

### Duplication Analysis

| Pattern | Files Affected | Code Lines | CSS Lines | Total |
|---------|---------------|------------|-----------|-------|
| ErrorOverlay | Competing, Snap-Ranking, Quiz | ~90 lines | ~177 lines | **267 lines** |
| FloatingTimer | Memory, Snap-Ranking | ~60 lines | ~70 lines | **130 lines** |
| Results/Completion Modal | All 4 game mechanics | ~350 lines | ~520 lines | **870 lines** |
| Action Handlers | Memory, Snap-Ranking, Competing | ~60 lines | - | **60 lines** |
| Time Formatting | Memory, Snap-Ranking, Competing | ~30 lines | - | **30 lines** |
| Button Styles | All 5 mechanics | - | ~200 lines | **200 lines** |

**Total Duplicated Code: ~1,557 lines** (590 TypeScript + 967 CSS)

### Architectural Inconsistency

Three mechanics use monolithic single-file components while two use modular structure:
- ❌ Memory, Snap-Ranking, Competing: Everything in one `components.tsx`
- ✅ Quiz, Collection: Properly modularised into separate component files

## Features

### Shared Components (Code Deduplication)

| ID | Feature | Complexity | Priority |
|----|---------|------------|----------|
| F-095 | Shared ErrorOverlay Component | Small | High |
| F-096 | Shared FloatingTimer Component | Small | High |
| F-097 | Shared GameCompletionModal Component | Medium | High |
| F-098 | useMechanicActions Hook | Small | Medium |
| F-099 | formatTime Utility | Small | Medium |
| F-100 | Shared Mechanics CSS Module | Medium | High |
| F-101 | Refactor Monolithic Mechanics | Large | Medium |

### Standardisation

| ID | Feature | Complexity | Priority |
|----|---------|------------|----------|
| F-102 | Visual Presentation Standards | Medium | High |
| F-103 | Configuration Standardisation | Medium | High |
| F-104 | UX Feedback Consistency | Medium | High |
| F-105 | Game Statistics Export/Import | Medium | Medium |
| F-106 | JSON-Based Mechanic Configuration | Large | Critical |

### Deferred Features (from earlier milestones)

| ID | Feature | Original Milestone | Priority |
|----|---------|-------------------|----------|
| F-019 | Accessibility Audit | v0.14.0 | Medium |
| F-026 | Component Storybook | v0.14.0 | Low |
| F-037 | Card Sorting (Expanded) | v0.12.0 | Medium |
| F-041 | Card Animation Polish | v0.14.0 | Low |
| F-067 | Statistics Dashboard | v0.12.0 | Medium |
| F-073 | User Documentation Suite | v0.11.1 | Medium |

## Work Packages

| Package | Description | Dependencies |
|---------|-------------|--------------|
| [WP-A](../../../prompts/implementation/v0.14.5/v0.14.5-shared-components.md) | Shared Components Library + Refactor | None |

## Dependencies

- **v0.14.0**: Advanced Mechanics (prerequisite - complete)

## Architecture

### New Directory Structure

```
src/mechanics/
├── shared/                          # NEW
│   ├── index.ts                     # Barrel exports
│   ├── components/
│   │   ├── index.ts
│   │   ├── ErrorOverlay.tsx         # ~30 lines
│   │   ├── FloatingTimer.tsx        # ~35 lines
│   │   └── GameCompletionModal.tsx  # ~80 lines
│   ├── hooks/
│   │   ├── index.ts
│   │   ├── useMechanicActions.ts    # ~25 lines
│   │   └── useGameTimer.ts          # ~30 lines
│   ├── utils/
│   │   └── formatTime.ts            # ~10 lines
│   ├── config/                      # NEW - Shared config
│   │   ├── breakpoints.json         # Standard responsive tiers
│   │   └── defaults.json            # Default values all mechanics inherit
│   ├── types.ts                     # NEW - Shared types
│   └── shared.module.css            # ~250 lines (consolidated)
├── memory/
│   ├── config/                      # NEW - Per-mechanic config
│   │   ├── settings.json            # Game settings
│   │   ├── display.json             # Responsive display config
│   │   └── themes.json              # Visual customisation
│   ├── components.tsx               # Refactored (< 100 lines)
│   └── ...
├── snap-ranking/
│   ├── config/                      # NEW
│   └── ...                          # Refactored
├── competing/
│   ├── config/                      # NEW
│   └── ...                          # Refactored + modularised
├── quiz/
│   ├── config/                      # NEW
│   └── ...                          # Already modular, use shared
├── collection/
│   ├── config/                      # NEW
│   └── ...                          # Already modular, minimal changes
├── types.ts
├── registry.ts
├── context.tsx
└── index.ts
```

### JSON Configuration Schema

**display.json** (per mechanic):
```json
{
  "breakpoints": {
    "mobile": { "maxWidth": 480, "cardSize": "small", "gridColumns": 3 },
    "tablet": { "maxWidth": 768, "cardSize": "medium", "gridColumns": 4 },
    "desktop": { "minWidth": 769, "cardSize": "default", "gridColumns": 6 }
  },
  "overlays": {
    "completionModal": {
      "mobile": { "fullScreen": true },
      "desktop": { "fullScreen": false, "width": "400px" }
    }
  }
}
```

**settings.json** (per mechanic):
```json
{
  "difficulty": {
    "easy": { "timeLimit": null, "cardCount": 8 },
    "medium": { "timeLimit": 60, "cardCount": 16 },
    "hard": { "timeLimit": 30, "cardCount": 24 }
  },
  "cardRequirements": { "minimum": 4, "recommended": 10 }
}
```

### Component Interfaces

**ErrorOverlay** (extracts from 3 mechanics):
```typescript
interface ErrorOverlayProps {
  title: string;
  message: string;
  hint?: string;
  onExit: () => void;
  visible: boolean;
}
```

**FloatingTimer** (extracts from 2 mechanics):
```typescript
interface FloatingTimerProps {
  timeMs: number;
  progressLabel?: string;
  visible: boolean;
  animated?: boolean;  // Use Framer Motion or plain div
}
```

**GameCompletionModal** (extracts from 4 mechanics):
```typescript
interface GameCompletionModalProps {
  isOpen: boolean;
  title: string;
  subtitle?: string;
  stats: Array<{ label: string; value: string | number }>;
  primaryAction: { label: string; onClick: () => void };
  secondaryAction?: { label: string; onClick: () => void };
  onExit: () => void;
  exitLabel?: string;
  children?: ReactNode;  // For mechanic-specific content
}
```

## Expected Outcomes

### Line Count Reductions

| Mechanic | Before | After | Reduction |
|----------|--------|-------|-----------|
| Memory components.tsx | 231 | ~80 | **-151 lines** |
| Snap-Ranking components.tsx | 427 | ~180 | **-247 lines** |
| Competing components.tsx | 539 | ~300 | **-239 lines** |
| Quiz (various) | 769 | ~650 | **-119 lines** |
| Collection (minimal) | 489 | ~480 | **-9 lines** |

### CSS Consolidation

| Before | After |
|--------|-------|
| 2,959 lines across 5 CSS modules | ~2,200 lines (shared + mechanic-specific) |
| **~800 lines of duplicated CSS** | **Eliminated** |

### Net Impact

- **Code removed:** ~765 lines TypeScript
- **CSS removed:** ~800 lines
- **New shared code:** ~210 lines TypeScript + 250 lines CSS
- **Net reduction:** ~1,105 lines

## Success Criteria

### Shared Components
- [ ] `src/mechanics/shared/` directory created with all components
- [ ] ErrorOverlay used by Competing, Snap-Ranking, Quiz
- [ ] FloatingTimer used by Memory, Snap-Ranking
- [ ] GameCompletionModal used by Memory, Snap-Ranking, Competing, Quiz
- [ ] useMechanicActions hook used by Memory, Snap-Ranking, Competing
- [ ] Memory components.tsx < 100 lines
- [ ] Snap-Ranking components.tsx < 200 lines
- [ ] Competing components.tsx < 350 lines (or modularised)
- [ ] No duplicate error overlay implementations
- [ ] No duplicate timer implementations

### Standardisation
- [ ] All games use `BaseGameSettings` interface
- [ ] Difficulty options consistent (Easy/Medium/Hard)
- [ ] Button labels follow standards ("Start", "Play Again", "Exit", "Back")
- [ ] Timer/progress display follows standards (MM:SS, X/Y)
- [ ] Consistent modal styling across all mechanics
- [ ] Game stats exportable in standard format

### Responsive Configuration
- [ ] Each mechanic has `config/` directory with JSON files
- [ ] All mechanics work on iPhone/iPad (small screens)
- [ ] No hardcoded responsive breakpoints in components
- [ ] Config files reference itemdeck.app features (not custom rendering)
- [ ] Shared breakpoints.json defines standard responsive tiers
- [ ] User config overrides supported with validation
- [ ] Fallback to defaults when user config invalid

### Quality
- [ ] All tests passing
- [ ] Bundle size reduced

## Release Preparation

- [ ] All work packages complete
- [ ] No code duplication in mechanics components
- [ ] Tests passing
- [ ] `/sync-docs` passing
- [ ] `/verify-docs` passing
- [ ] `/pii-scan` passing
- [ ] Documentation updated
- [ ] Devlog created
- [ ] Retrospective written

---

## Related Documentation

- [Roadmap Overview](../README.md)
- [v0.14.0: Advanced Mechanics](./v0.14.0.md)
- [Implementation Prompt](../../../prompts/implementation/v0.14.5/v0.14.5-shared-components.md)

---

**Status**: Planned
