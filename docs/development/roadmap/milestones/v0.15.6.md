# v0.15.6 - Settings Consistency & Bug Fixes

## Overview

Bug fix release addressing Settings dialogue inconsistencies discovered through user testing. Ensures all settings work correctly with the F-090 draft state pattern and fixes several UX issues.

**Theme:** Bug fixes, settings consistency, stability

## Bugs Fixed

| Bug | Description | Root Cause |
|-----|-------------|------------|
| **Default Card Face** | Changing to "Front" flipped cards during preview but reverted on Accept | Draft pattern not used (direct setters) |
| **Show Drag Icon** | Toggle had zero effect | Orphaned setting (never consumed) |
| **UI Not Updating** | Settings UI didn't update after first change | Missing `_draft` subscription in Zustand |
| **Card Flip on Drag** | Card reverted to default face after drag-drop | Order-sensitive card set comparison |
| **Duplicate Settings** | Same settings in multiple locations | UX confusion |

## Features

No new features - bug fix release only.

## Dependencies

- **v0.15.5**: Infrastructure & Documentation (prerequisite)

## Key Implementation Notes

### Draft Pattern Consistency

Migrated all settings components to use `getEffective()` and `updateDraft()`:
- `AppearanceSettingsTabs.tsx`
- `ThemeSettingsTabs.tsx`
- `CardSettingsTabs.tsx`
- `ConfigSettingsTabs.tsx`
- `QuickSettings.tsx`
- `SystemSettings.tsx`

### Zustand Subscription Fix

Added explicit `_draft` subscription to trigger re-renders:
```typescript
// Subscribe to _draft to trigger re-renders when draft changes
useSettingsStore((s) => s._draft);
const getEffective = useSettingsStore((s) => s.getEffective);
```

### Card Flip State Preservation

Changed card ID comparison to be order-insensitive:
```typescript
// Before (order-sensitive)
const currentIdsKey = cards.map(c => c.id).join(',');

// After (order-insensitive)
const sortedIds = cards.map(c => c.id).sort();
const currentIdsKey = sortedIds.join(',');
```

### showDragIcon Connection

Connected orphaned setting through the component chain:
- `CardGrid.tsx` reads from store
- `DraggableCardGrid.tsx` receives as prop
- `SortableCard` controls `showFrontDragHandle` and `showBackDragHandle`

### Duplicate Settings Removal

Removed from `ConfigSettingsTabs.tsx`:
- "Show Cards" (Default Card Face) - canonical: Appearance > Interactions
- "Shuffle on Load" - canonical: Quick tab
- Entire "Behaviour" sub-tab (now empty)

## Success Criteria

- [x] All settings changes preview correctly during editing
- [x] Cancel discards ALL uncommitted changes
- [x] Accept commits ALL changes permanently
- [x] showDragIcon toggle controls drag handle visibility
- [x] No settings are orphaned (all have consumers)
- [x] Settings persist correctly across page refreshes
- [x] Card flip state preserved during drag-and-drop

## Release Preparation

- [x] All bugs fixed (5/5)
- [x] Tests passing (722)
- [x] Build successful
- [x] TypeScript compilation clean
- [x] ESLint passing
- [x] `/pii-scan` passing
- [x] Documentation updated
- [x] Devlog created
- [x] Retrospective written

---

## Related Documentation

- [Roadmap Overview](../README.md)
- [v0.15.5: Infrastructure & Documentation](./v0.15.5.md)
- [v0.15.6 Devlog](../../process/devlogs/v0.15.6/README.md)
- [v0.15.6 Retrospective](../../process/retrospectives/v0.15.6/README.md)
- [F-090 Draft State Pattern](../features/completed/F-090-settings-draft-state.md)
- [Implementation Prompt](../../../prompts/implementation/v0.15.6/README.md)

---

**Status**: âœ… Complete
