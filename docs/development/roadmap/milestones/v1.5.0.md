# v1.5.0: Full Plugin Ecosystem

## Overview

Transform Itemdeck into a fully modular, extensible platform where settings, themes, game mechanics, and data sources are all plugin-based. Enable three distribution tiers: built-in essentials, curated extensions, and community-hosted plugins.

## Theme

**Extensibility & Distribution** - Making every aspect of Itemdeck customisable through a plugin ecosystem with secure distribution channels.

## Goals

1. **Full Modularity** - Settings, themes, mechanics, and sources as plugins
2. **Built-in Essentials** - Core plugins bundled with the application
3. **Curated Extensions** - Vetted plugins from an official registry
4. **Community Plugins** - User-hosted plugins via URL (initially GitHub-only)
5. **Security First** - Sandboxed execution, permission model, validation

## Features

### Core Plugin Infrastructure

| ID | Feature | Priority | Complexity |
|----|---------|----------|------------|
| [F-122](../features/planned/F-122-plugin-manifest-schema.md) | Plugin Manifest Schema | Critical | Medium |
| [F-123](../features/planned/F-123-plugin-loader-registry.md) | Plugin Loader & Registry | Critical | High |
| [F-124](../features/planned/F-124-plugin-security-sandbox.md) | Plugin Security Sandbox | Critical | High |
| [F-125](../features/planned/F-125-plugin-permission-model.md) | Plugin Permission Model | High | Medium |

### Plugin Types

| ID | Feature | Priority | Complexity |
|----|---------|----------|------------|
| [F-126](../features/planned/F-126-settings-schema-plugins.md) | Settings Schema Plugins | High | Medium |
| [F-127](../features/planned/F-127-theme-package-plugins.md) | Theme Package Plugins | High | Medium |
| [F-128](../features/planned/F-128-mechanic-plugins-external.md) | Mechanic Plugins (External) | High | High |
| [F-129](../features/planned/F-129-source-adapter-plugins.md) | Source Adapter Plugins | Medium | High |

### Distribution System

| ID | Feature | Priority | Complexity |
|----|---------|----------|------------|
| [F-130](../features/planned/F-130-builtin-plugin-bundling.md) | Built-in Plugin Bundling | High | Medium |
| [F-131](../features/planned/F-131-curated-registry-api.md) | Curated Registry API | Medium | High |
| [F-132](../features/planned/F-132-community-plugin-loading.md) | Community Plugin Loading | Medium | High |
| [F-133](../features/planned/F-133-plugin-activation-ui.md) | Plugin Activation UI | High | Medium |

## Implementation Tracks

Work can proceed in parallel across these tracks:

| Track | Focus | Features | Est. Hours |
|-------|-------|----------|------------|
| **A** | Core Infrastructure | F-122, F-123, F-124, F-125 | 46-62 |
| **B** | Plugin Types | F-126, F-127, F-128, F-129 | 48-64 |
| **C** | Distribution | F-130, F-131, F-132, F-133 | 44-58 |

**Total Estimated Effort: 138-184 hours**

### Track Dependencies

```
Track A (Infrastructure) ────────────────────────────────────┐
    │                                                         │
    ├── F-122: Plugin Manifest Schema                         │
    │      ↓                                                  │
    ├── F-123: Plugin Loader & Registry                       ├──► All tracks
    │      ↓                                                  │    depend on A
    ├── F-124: Plugin Security Sandbox                        │
    │      ↓                                                  │
    └── F-125: Plugin Permission Model ──────────────────────┘
                       │
         ┌─────────────┴─────────────┐
         ▼                           ▼
    Track B (Types)             Track C (Distribution)
    F-126, F-127, F-128, F-129  F-130, F-131, F-132, F-133
```

## Scope

### Plugin Types

| Type | Description | Built-in Examples |
|------|-------------|-------------------|
| **Settings** | Schema-defined configuration options | Default settings, accessibility |
| **Themes** | Visual customisation (CSS, fonts, images) | Light, Dark, High Contrast |
| **Mechanics** | Game modes and interactions | Memory, Quiz, Competing, Collection |
| **Sources** | Data source adapters | GitHub (`gh.json`) |

### Distribution Tiers

| Tier | Source | Activation | Trust Level |
|------|--------|------------|-------------|
| **Built-in** | Bundled with app | Always active | Full |
| **Curated** | Official registry | User activates | Verified |
| **Community** | GitHub URL | User provides URL | Sandboxed |

### Security Model

```
┌─────────────────────────────────────────────────────────┐
│                    Plugin Sandbox                        │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │ Plugin Code     │  │ Allowed APIs                 │  │
│  │ (Isolated)      │──│ • React components           │  │
│  │                 │  │ • Settings store (scoped)    │  │
│  │                 │  │ • Theme CSS variables        │  │
│  │                 │  │ • Card data (read-only)      │  │
│  └─────────────────┘  └─────────────────────────────┘  │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Blocked APIs                                     │   │
│  │ • localStorage (direct)                          │   │
│  │ • fetch (except allowlisted domains)            │   │
│  │ • DOM manipulation (outside plugin root)         │   │
│  │ • eval / Function constructor                    │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

## Architecture

### Plugin Manifest Schema

```json
{
  "$schema": "https://itemdeck.app/schemas/plugin.json",
  "id": "my-theme-plugin",
  "version": "1.0.0",
  "name": "My Custom Theme",
  "description": "A beautiful custom theme",
  "author": "username",
  "type": "theme",
  "permissions": ["theme:write", "settings:read"],
  "main": "./index.js",
  "assets": {
    "css": ["./theme.css"],
    "fonts": ["./fonts/custom.woff2"]
  },
  "dependencies": {
    "itemdeck": ">=1.5.0"
  }
}
```

### Directory Structure

```
src/
├── plugins/
│   ├── core/
│   │   ├── loader.ts              # Plugin loader
│   │   ├── registry.ts            # Plugin registry
│   │   ├── sandbox.ts             # Security sandbox
│   │   ├── manifest.ts            # Manifest parser/validator
│   │   └── types.ts               # Plugin types
│   ├── builtins/
│   │   ├── settings/              # Default settings plugin
│   │   ├── themes/                # Built-in themes
│   │   │   ├── light/
│   │   │   ├── dark/
│   │   │   └── high-contrast/
│   │   ├── mechanics/             # Built-in mechanics
│   │   │   ├── memory/
│   │   │   ├── quiz/
│   │   │   ├── competing/
│   │   │   └── collection/
│   │   └── sources/               # Built-in source adapters
│   │       └── github/
│   │           └── gh.json
│   ├── curated/
│   │   └── registry.ts            # Curated registry client
│   └── community/
│       └── loader.ts              # GitHub URL loader
├── stores/
│   └── pluginStore.ts             # Plugin state management
└── components/
    └── PluginManager/             # Plugin activation UI
```

### Source Adapter Example (`gh.json`)

```json
{
  "$schema": "https://itemdeck.app/schemas/source-adapter.json",
  "id": "github",
  "name": "GitHub",
  "description": "Load collections from GitHub repositories",
  "urlPatterns": [
    "https://github.com/{owner}/{repo}",
    "https://raw.githubusercontent.com/{owner}/{repo}/{branch}/{path}"
  ],
  "discovery": {
    "type": "api",
    "endpoint": "https://api.github.com/repos/{owner}/{repo}/contents/{path}",
    "headers": {
      "Accept": "application/vnd.github.v3+json"
    }
  },
  "authentication": {
    "type": "token",
    "optional": true,
    "scopes": ["repo:read"]
  }
}
```

## Dependencies

```
v1.0.0 Multi-Collection
    │
    ▼
v1.5.0 Full Plugin Ecosystem ← THIS MILESTONE
    │
    ▼
v2.0.0 Internationalisation
```

## Success Criteria

### Core Infrastructure
- [ ] Plugin manifest schema defined and documented
- [ ] Plugin loader handles all plugin types
- [ ] Security sandbox prevents unauthorised access
- [ ] Permission model enforces least privilege

### Plugin Types
- [ ] Settings plugins can add new configuration options
- [ ] Theme plugins can override CSS and add fonts
- [ ] Mechanic plugins can add new game modes
- [ ] Source plugins can add new data sources

### Distribution
- [ ] Built-in plugins bundled and always available
- [ ] Curated registry API functional
- [ ] Community plugins loadable from GitHub URLs
- [ ] Plugin activation UI in Settings

### Quality
- [ ] All existing tests pass
- [ ] Plugin API documented
- [ ] Developer guide for creating plugins
- [ ] Security audit completed

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Security vulnerabilities | Medium | Critical | Sandbox, code review, CSP |
| Plugin API instability | Medium | High | Semantic versioning, deprecation |
| Performance degradation | Medium | Medium | Lazy loading, code splitting |
| Breaking existing mechanics | Low | High | Migration path, compatibility layer |

## Preparation Checklist

- [x] Research: state-of-the-art-plugin-architecture.md
- [x] Research: state-of-the-art-web-security-sandbox.md
- [x] ADR: Plugin Trust Tiers (ADR-023)
- [x] ADR: Plugin Sandbox Implementation (ADR-024)
- [x] ADR: Plugin Distribution Strategy (ADR-025)
- [x] ADR: Plugin Manifest Schema (ADR-026)
- [x] Feature specs: F-122 to F-133

## Release Preparation

- [ ] All features complete
- [ ] Plugin API stable
- [ ] Security audit passed
- [ ] Developer documentation complete
- [ ] Migration guide for existing mechanics
- [ ] Tests passing
- [ ] `/sync-docs` passing
- [ ] `/verify-docs` passing
- [ ] `/pii-scan` passing
- [ ] Devlog created
- [ ] Retrospective written

---

## Related Documentation

- [v1.0.0 Milestone](./v1.0.0.md) (prerequisite)
- [v2.0.0 Milestone](./v2.0.0.md)
- [Plugin Architecture Research](../../research/state-of-the-art-plugin-architecture.md)
- [Plugin Security Research](../../research/state-of-the-art-web-security-sandbox.md)

---

**Status**: Planned
