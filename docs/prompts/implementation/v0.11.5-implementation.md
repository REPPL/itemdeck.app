# v0.11.5 Implementation Prompt

## Milestone Overview

v0.11.5 is a significant UI and architecture update focusing on Settings Panel restructuring, per-collection settings, custom fonts, and caching improvements.

---

## 1. Navigation Hub Redesign

### Requirements
- Replace Plus→X icon with **Menu→X** (hamburger when collapsed, X when expanded)
- Secondary buttons (Settings, Games, Search, View) should be **slightly smaller** than primary buttons (Help, Navigation)
- Use `AnimatePresence` to swap icons instead of rotation animation

### Files to Modify
- `/src/components/NavigationHub/NavigationHub.tsx`
- `/src/components/NavigationHub/NavigationHub.module.css`

### Implementation Details
```tsx
// Replace PlusIcon with MenuIcon (hamburger)
function MenuIcon() {
  return (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"
         strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
      <line x1="3" y1="6" x2="21" y2="6" />
      <line x1="3" y1="12" x2="21" y2="12" />
      <line x1="3" y1="18" x2="21" y2="18" />
    </svg>
  );
}

// Add CloseIcon for expanded state
function CloseIcon() {
  return (
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"
         strokeLinecap="round" strokeLinejoin="round" aria-hidden="true">
      <line x1="18" y1="6" x2="6" y2="18" />
      <line x1="6" y1="6" x2="18" y2="18" />
    </svg>
  );
}
```

CSS for secondary buttons:
```css
.buttonSecondary {
  width: 48px;
  height: 48px;
}
.buttonSecondary svg {
  width: 24px;
  height: 24px;
}
@media (max-width: 600px) {
  .buttonSecondary { width: 40px; height: 40px; }
  .buttonSecondary svg { width: 20px; height: 20px; }
}
```

---

## 2. Settings Panel Overhaul

### UI Changes
- Remove 'X' close button (keep only 'Cancel' button)
- Move 'Search settings...' input to upper right corner

### New Tab Structure

**First-level tabs:** Quick | Appearance | Collections | Data | System

#### Quick Tab
Remove: Statistics Bar toggle, Refresh Data button

Include:
- Current Theme (dropdown)
- Card Size (Small/Medium/Large)
- View Mode (Grid/List/Compact)
- Shuffle cards on Load (toggle)
- Random Selection (toggle + count with "out of X cards" subtext)
- Activate Games Mode (button)

All Quick settings CAN be overwritten by collection settings.json.

#### Appearance Tab
**(Structure to be provided during development)**

Will include:
- Theme customisation (colours, borders, shadows, animations)
- Font settings per theme (NEW)
- Card appearance
- Field mapping
- Interaction settings

#### Collections Tab
**Second-level tabs:** Sources | Add Source | Edit Source | Import/Export

- **Sources:** Configured sources list, health status, active/default buttons
- **Add Source:** GitHub username + display name → Scan → Select collections → Add
- **Edit Source:** Local edits management, revert edits
- **Import/Export:** Collection import/export as JSON

#### Data Tab
**Second-level tabs:** About | Image Cache | Themes | Settings

- **About:** Third-level tabs explaining each data type
- **Image Cache:** Statistics, clear cache (no Re-cache button)
- **Themes:** Import/export theme JSON files
- **Settings:** Import/export settings JSON, reset to defaults

#### System Tab
**Note:** Dark mode & accessibility CANNOT be overwritten by collection settings.
**Note:** UI Visibility CAN be overwritten.

Remove: Refresh Data button

- Dark Mode: [System] [Light] [Dark]
- **Second-level tabs:** Accessibility | UI Visibility | Developer

**UI Visibility additions:**
- Show View Button (NEW)

---

## 3. Per-Collection Settings

### Requirements
- Support `settings.json` file in each collection directory
- **Hybrid override mode:**
  - Forced: Always applied (field mapping, defaultCardFace, badges)
  - Defaults: First load only (theme, cardSize, fonts)
- Alert user when collection settings are applied
- Confirmation dialogue for all destructive actions

### Type Definitions
Create `/src/types/collectionSettings.ts`:
```typescript
export interface ForcedSettings {
  fieldMapping?: Partial<FieldMappingConfig>;
  defaultCardFace?: "front" | "back";
  cardBackDisplay?: CardBackDisplay;
  cardBackStyle?: CardBackStyle;
  titleDisplayMode?: TitleDisplayMode;
  showRankBadge?: boolean;
  showDeviceBadge?: boolean;
  rankPlaceholderText?: string;
}

export interface DefaultSettings {
  visualTheme?: VisualTheme;
  cardSizePreset?: CardSizePreset;
  cardAspectRatio?: CardAspectRatio;
  maxVisibleCards?: number;
  shuffleOnLoad?: boolean;
  themeCustomisations?: Partial<Record<VisualTheme, ThemeCustomisationOverride>>;
  searchFields?: string[];
  groupByField?: string | null;
}

export interface CollectionSettings {
  version: number;
  forced?: ForcedSettings;
  defaults?: DefaultSettings;
}
```

### Settings Store v26 Changes
Add to `/src/stores/settingsStore.ts`:
- `showViewButton: boolean` (default: true)
- `collectionForcedSettings: ForcedSettings | null`
- `appliedCollectionDefaultsSourceId: string | null`
- Add `fontFamily?: string` and `fontUrl?: string` to ThemeCustomisation

---

## 4. Custom Fonts per Theme

### Requirements
- Different fonts per theme (PC VGA for retro, C64, etc.)
- Cache fonts in IndexedDB
- Apply via CSS custom property `--theme-font-family`

### Files to Create
- `/src/db/index.ts` - Add `fonts` object store (schema v3)
- `/src/services/fontCache.ts` - Font caching service
- `/src/hooks/useFontLoader.ts` - Font loading hook with FontFace API

### Default Fonts
| Theme | Font | Fallback |
|-------|------|----------|
| retro | Perfect DOS VGA 437 | monospace |
| modern | System UI | sans-serif |
| minimal | Inter | system-ui |

---

## 5. Caching Improvements

### Requirements
- Fix duplicate collection entries in cache
- Use HTTP headers (ETag/Last-Modified) for update detection
- Show dialogue when update available

### Implementation
Update `/src/lib/cardCache.ts`:
```typescript
interface CachedData<T> {
  data: T;
  timestamp: number;
  version: string;
  etag?: string;
  lastModified?: string;
}
```

Add functions:
- `checkForCollectionUpdate(sourceId, url)` - HEAD request with conditional headers
- `getAllCachedCollections()` - List all cached collections

Create `/src/components/CacheUpdateDialog/` for update notifications.

---

## 6. Confirmation Dialogues

### Requirements
All destructive actions require confirmation:
- Reset all settings
- Clear image cache
- Clear collection cache
- Remove source
- Revert all edits

### Implementation
Create `/src/components/ConfirmDialog/ConfirmDialog.tsx`:
```typescript
interface ConfirmDialogProps {
  isOpen: boolean;
  title: string;
  message: string;
  confirmLabel?: string;
  cancelLabel?: string;
  variant?: "warning" | "danger";
  onConfirm: () => void;
  onCancel: () => void;
}
```

---

## Demo Settings Files (MyPlausibleMe)

### retro-adverts/settings.json
```json
{
  "version": 1,
  "forced": {
    "defaultCardFace": "back",
    "fieldMapping": {
      "titleField": "title",
      "subtitleField": "year",
      "footerBadgeField": "publication",
      "sortField": "year",
      "sortDirection": "desc"
    },
    "cardBackDisplay": "logo",
    "showRankBadge": false
  },
  "defaults": {
    "visualTheme": "retro",
    "cardSizePreset": "large",
    "cardAspectRatio": "3:4",
    "themeCustomisations": {
      "retro": {
        "accentColour": "#d4af37",
        "cardBackgroundColour": "#2d1f0f",
        "fontFamily": "C64 Pro"
      }
    }
  }
}
```

### retro-games/settings.json
```json
{
  "version": 1,
  "forced": {
    "defaultCardFace": "front",
    "fieldMapping": {
      "titleField": "title",
      "subtitleField": "year",
      "footerBadgeField": "platform.shortTitle",
      "logoField": "platform.images[0].url",
      "sortField": "order",
      "sortDirection": "asc"
    },
    "cardBackDisplay": "both",
    "showRankBadge": true,
    "showDeviceBadge": true
  },
  "defaults": {
    "visualTheme": "modern",
    "cardSizePreset": "medium",
    "shuffleOnLoad": true,
    "themeCustomisations": {
      "retro": {
        "fontFamily": "Perfect DOS VGA 437"
      }
    }
  }
}
```

---

## Implementation Order

1. Foundation: Types, ConfirmDialog, settings store v26
2. Navigation Hub: Menu/X icons, secondary button sizing
3. Settings Panel: New tab structure, component reorganisation
4. Fonts: IndexedDB schema v3, font cache service, loader hook
5. Per-Collection Settings: Loader, alert component, context integration
6. Caching: ETag/Last-Modified, update dialogue
7. Confirmations: Apply to all destructive actions
8. Testing & Documentation
