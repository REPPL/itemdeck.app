# Work Package A: Plugin Core Infrastructure

## Overview

Build the foundational plugin system for itemdeck.app including manifest schemas, state management, caching, loading, and security sandboxing.

**Version:** v0.13.0
**Dependencies:** None (can run in parallel with WP-C)
**Estimated Scope:** ~20 new files, ~2500 lines of code

---

## Context

itemdeck.app is a React/TypeScript card collection viewer. v0.12.5 introduced:
- `src/schemas/mechanic-manifest.schema.ts` - Zod schema for mechanic plugins
- `src/mechanics/snap-ranking/manifest.json` - Example mechanic manifest

This work package extends that foundation to support all plugin types.

---

## Objectives

1. Create unified plugin manifest schema supporting Settings, Themes, Mechanics, and Sources
2. Implement Zustand store for plugin state with persistence
3. Implement IndexedDB cache for plugin assets
4. Create plugin loader with lazy loading support
5. Implement Web Worker sandbox for community plugins
6. Create capability-based permission system

---

## Technical Requirements

### 1. Plugin Manifest Schema

**Location:** `src/plugins/schemas/`

**Files to create:**
- `manifest.ts` - Core plugin manifest schema
- `contributions/settings.ts` - Settings contribution schema
- `contributions/theme.ts` - Theme contribution schema
- `contributions/mechanic.ts` - Mechanic contribution schema (refactor from existing)
- `contributions/source.ts` - Source contribution schema
- `index.ts` - Barrel exports

**Core Manifest Structure:**
```typescript
{
  "$schema": "https://itemdeck.app/schemas/plugin/v1.json",
  "id": "org.example.my-plugin",  // Reverse domain notation
  "name": "My Plugin",
  "version": "1.0.0",  // Semver
  "description": "Plugin description",
  "author": {
    "name": "Developer Name",
    "url": "https://example.org"
  },
  "licence": "MIT",

  "itemdeck": {
    "minVersion": "0.13.0",
    "maxVersion": "1.x",
    "type": "mechanic" | "theme" | "settings" | "source",
    "tier": "builtin" | "official" | "community"
  },

  "capabilities": ["storage:local", "ui:notifications", "collection:read"],

  "entry": {
    "main": "./dist/index.js",
    "styles": "./dist/styles.css"
  },

  "contributes": {
    "settings": [...],
    "themes": [...],
    "mechanics": [...],
    "sources": [...]
  }
}
```

**Validation Requirements:**
- Use Zod for runtime validation
- Semver pattern validation for versions
- Capability enum validation
- Type-specific contribution validation

---

### 2. Plugin Store (Zustand)

**Location:** `src/stores/pluginStore.ts`

**State Shape:**
```typescript
interface PluginState {
  // Installed plugins
  installedPlugins: Map<string, InstalledPluginInfo>;

  // Plugin configurations
  pluginConfigs: Map<string, Record<string, unknown>>;

  // Active plugins by type
  activeTheme: string | null;
  activeMechanics: string[];
  activeSources: string[];

  // User preferences
  preferences: {
    autoUpdate: boolean;
    allowCommunityPlugins: boolean;
    trustedDomains: string[];
  };

  // Actions
  installPlugin: (manifest: PluginManifest, tier: PluginTier) => void;
  uninstallPlugin: (pluginId: string) => void;
  enablePlugin: (pluginId: string) => void;
  disablePlugin: (pluginId: string) => void;
  setPluginConfig: (pluginId: string, config: Record<string, unknown>) => void;
  setActiveTheme: (pluginId: string | null) => void;
  grantCapability: (pluginId: string, capability: Capability) => void;
  revokeCapability: (pluginId: string, capability: Capability) => void;
}
```

**Requirements:**
- Use `persist` middleware for localStorage persistence
- Handle Map serialisation/deserialisation
- Export typed selector hooks

---

### 3. Plugin Cache (IndexedDB)

**Location:** `src/plugins/cache/pluginCache.ts`

**Database Schema:**
```typescript
interface PluginCacheDB {
  manifests: {
    key: string;  // pluginId
    value: {
      manifest: PluginManifest;
      cachedAt: Date;
      expiresAt: Date;
    };
    indexes: ['by-type', 'by-expires'];
  };
  assets: {
    key: string;  // `${pluginId}/${assetPath}`
    value: {
      data: Blob;
      mimeType: string;
      cachedAt: Date;
    };
  };
  configs: {
    key: string;  // pluginId
    value: {
      pluginId: string;
      config: Record<string, unknown>;
      updatedAt: Date;
    };
  };
}
```

**Requirements:**
- Use existing `idb` package
- Integrate with `src/db/index.ts`
- 7-day cache expiry for manifests
- Cleanup method for expired entries

---

### 4. Plugin Loader

**Location:** `src/plugins/loader/`

**Files:**
- `pluginLoader.ts` - Main loader class
- `lazyLoader.ts` - On-demand loading with deduplication

**PluginLoader Interface:**
```typescript
class PluginLoader {
  // Load plugin from source
  loadPlugin(source: PluginSource, options?: LoadOptions): Promise<LoadedPlugin>;

  // Enable/disable
  enablePlugin(pluginId: string): Promise<void>;
  disablePlugin(pluginId: string): Promise<void>;

  // Query
  getPlugin(pluginId: string): LoadedPlugin | undefined;
  getPluginsByType(type: PluginType): LoadedPlugin[];

  // Lifecycle
  initializeBuiltins(): Promise<void>;
}

interface LoadedPlugin {
  manifest: PluginManifest;
  instance: PluginInstance | null;
  sandbox: WorkerSandbox | null;
  state: 'pending' | 'loading' | 'active' | 'disabled' | 'error';
  loadedAt: Date;
}
```

**LazyLoader Requirements:**
- Deduplicate concurrent load requests
- Return same promise for in-flight loads
- Preload manifests for specific contexts

---

### 5. Security & Sandboxing

**Location:** `src/plugins/security/` and `src/plugins/sandbox/`

#### Capability System

**File:** `src/plugins/security/capabilities.ts`

**Capabilities:**
```typescript
type Capability =
  // Storage
  | 'storage:local'
  | 'storage:sync'
  | 'storage:unlimited'
  // UI
  | 'ui:notifications'
  | 'ui:modal'
  | 'ui:overlay'
  // Collection
  | 'collection:read'
  | 'collection:write'
  | 'collection:delete'
  // Network
  | 'fetch:sameorigin'
  | 'fetch:external'
  // System
  | 'audio:play'
  | 'clipboard:read'
  | 'clipboard:write'
  // Dangerous (blocked for community)
  | 'dangerous:eval'
  | 'dangerous:dom';
```

**Tier Limits:**
| Capability | Built-in | Official | Community |
|------------|----------|----------|-----------|
| storage:local | Yes | Yes | Yes |
| storage:unlimited | Yes | Consent | Blocked |
| collection:read | Yes | Yes | Yes |
| collection:write | Yes | Yes | Consent |
| fetch:external | Yes | Yes | Consent |
| dangerous:* | Yes | Blocked | Blocked |

#### Web Worker Sandbox

**File:** `src/plugins/sandbox/workerSandbox.ts`

**Requirements:**
- Wrap plugin code in isolated Worker
- Remove dangerous globals (fetch, eval, Function)
- Inject capability-gated API
- Message-based communication with timeouts
- Proper cleanup on termination

**Plugin API (injected into sandbox):**
```typescript
const itemdeck = {
  storage: {
    get: (key: string) => Promise<unknown>,
    set: (key: string, value: unknown) => Promise<void>,
  },
  ui: {
    notify: (message: string, type?: 'info' | 'success' | 'error') => void,
  },
  collection: {
    getCards: () => Promise<CardData[]>,
    getSelected: () => Promise<CardData[]>,
  },
};
```

#### Permission Manager

**File:** `src/plugins/security/permissionManager.ts`

**Functions:**
- `checkCapability(pluginId, capability): boolean`
- `requestCapability(pluginId, capability): Promise<boolean>`
- `revokeCapability(pluginId, capability): void`
- `getGrantedCapabilities(pluginId): Capability[]`

---

### 6. Validation Pipeline

**Location:** `src/plugins/validation/validator.ts`

**Validation Steps:**
1. Schema validation (Zod)
2. Capability validation against tier limits
3. Dependency validation (if declared)
4. Security checks for community plugins
5. Content policy checks

**Output:**
```typescript
interface ValidationResult {
  valid: boolean;
  errors: ValidationError[];
  warnings: ValidationWarning[];
  sanitized?: PluginManifest;
}
```

---

## File Structure

```
src/plugins/
├── schemas/
│   ├── manifest.ts
│   ├── contributions/
│   │   ├── settings.ts
│   │   ├── theme.ts
│   │   ├── mechanic.ts
│   │   └── source.ts
│   └── index.ts
├── loader/
│   ├── pluginLoader.ts
│   └── lazyLoader.ts
├── cache/
│   └── pluginCache.ts
├── security/
│   ├── capabilities.ts
│   └── permissionManager.ts
├── sandbox/
│   ├── workerSandbox.ts
│   └── pluginAPI.ts
├── validation/
│   └── validator.ts
└── index.ts
```

---

## Integration Points

### App.tsx
- Add `PluginProvider` context
- Initialize plugin loader on mount
- Load built-in plugins

### src/db/index.ts
- Add plugin cache tables to database schema

---

## Testing Requirements

Create tests in `tests/plugins/`:
- `schemas/manifest.test.ts` - Schema validation
- `security/capabilities.test.ts` - Capability checks
- `loader/pluginLoader.test.ts` - Load/enable/disable
- `validation/validator.test.ts` - Validation pipeline

---

## Success Criteria

- [ ] All plugin manifest schemas validate correctly
- [ ] Plugin store persists across sessions
- [ ] Cache stores and retrieves manifests/assets
- [ ] Loader can load, enable, disable plugins
- [ ] Web Worker sandbox isolates community plugins
- [ ] Capability system enforces tier limits
- [ ] All tests pass

---

## Notes

- Follow existing code patterns in the codebase
- Use British English in all documentation and comments
- No new npm dependencies required
- Maintain TypeScript strict mode compliance
