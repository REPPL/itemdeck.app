# Work Package B: Migration to Plugin Architecture

## Overview

Migrate existing themes, mechanics, and sources to the new plugin architecture. This validates the plugin system works correctly with real implementations.

**Version:** v0.13.0
**Dependencies:** WP-A (Plugin Core) must be complete
**Estimated Scope:** ~15 new files, ~1500 lines refactored

---

## Context

After WP-A completes, we have:
- Plugin manifest schemas
- Plugin store (Zustand)
- Plugin cache (IndexedDB)
- Plugin loader
- Security/sandbox system

This work package migrates existing features to use that infrastructure.

---

## Objectives

1. Create plugin type adapters (theme, mechanic, settings, source)
2. Migrate 3 themes (retro, modern, minimal) to built-in plugins
3. Migrate 2 mechanics (memory, snap-ranking) to built-in plugins
4. Migrate GitHub source to built-in plugin
5. Remove legacy registration code

---

## Technical Requirements

### 1. Plugin Type Adapters

**Location:** `src/plugins/integration/`

#### Theme Adapter

**File:** `src/plugins/integration/themeAdapter.ts`

**Responsibilities:**
- Apply theme tokens as CSS custom properties
- Load custom CSS from plugin assets
- Set `data-theme` and `data-theme-type` attributes on document
- Handle theme switching

**Interface:**
```typescript
class ThemePluginAdapter {
  applyTheme(pluginId: string, contribution: ThemeContribution): Promise<void>;
  removeCurrentTheme(): void;
  getCurrentTheme(): string | null;
}
```

**Token to CSS Mapping:**
```typescript
// Theme contribution tokens
{
  colours: {
    primary: "#00ffff",
    background: "#0a0a0f"
  },
  typography: {
    fontFamily: "'Orbitron', sans-serif"
  },
  borders: {
    radius: "4px"
  }
}

// Becomes CSS custom properties
:root {
  --colour-primary: #00ffff;
  --colour-background: #0a0a0f;
  --font-family: 'Orbitron', sans-serif;
  --border-radius: 4px;
}
```

#### Mechanic Adapter

**File:** `src/plugins/integration/mechanicAdapter.ts`

**Responsibilities:**
- Register mechanics from plugin contributions
- Create mechanic instances (sandboxed for community)
- Integrate with existing `src/mechanics/registry.ts`
- Handle mechanic lifecycle

**Interface:**
```typescript
class MechanicPluginAdapter {
  registerFromPlugin(pluginId: string, contribution: MechanicContribution): Promise<void>;
  unregisterFromPlugin(pluginId: string): void;
  createMechanicInstance(mechanicId: string, config: unknown): Promise<MechanicInstance>;
}
```

**Integration with Existing Registry:**
- Wrap existing `mechanicRegistry.register()` calls
- Mechanic IDs become `${pluginId}:${mechanicId}`
- Preserve existing mechanic interface

#### Settings Adapter

**File:** `src/plugins/integration/settingsAdapter.ts`

**Responsibilities:**
- Merge plugin settings contributions into settings UI
- Handle plugin-specific setting storage
- Validate setting values against schemas

**Interface:**
```typescript
class SettingsPluginAdapter {
  registerSettings(pluginId: string, contributions: SettingContribution[]): void;
  unregisterSettings(pluginId: string): void;
  getAllSettings(): MergedSettingDefinition[];
  getSettingValue(pluginId: string, settingId: string): unknown;
  setSettingValue(pluginId: string, settingId: string, value: unknown): void;
}
```

#### Source Adapter

**File:** `src/plugins/integration/sourceAdapter.ts`

**Responsibilities:**
- Register data sources from plugin contributions
- Handle source configuration
- Integrate with collection loading

**Interface:**
```typescript
class SourcePluginAdapter {
  registerFromPlugin(pluginId: string, contribution: SourceContribution): Promise<void>;
  unregisterFromPlugin(pluginId: string): void;
  getAvailableSources(): SourceDefinition[];
  loadCollection(sourceId: string, config: unknown): Promise<Collection>;
}
```

---

### 2. Theme Migration

**Location:** `src/plugins/builtin/themes/`

#### Retro Theme

**Directory:** `src/plugins/builtin/themes/retro/`

**Files:**
- `manifest.json` - Plugin manifest
- `theme.css` - Theme styles (migrate from `src/styles/themes/retro.css`)
- `index.ts` - Entry point

**manifest.json:**
```json
{
  "$schema": "https://itemdeck.app/schemas/plugin/v1.json",
  "id": "org.itemdeck.theme-retro",
  "name": "Retro",
  "version": "1.0.0",
  "description": "Classic retro gaming aesthetic with pixel-perfect details",
  "author": {
    "name": "itemdeck"
  },
  "licence": "GPL-3.0-or-later",
  "itemdeck": {
    "minVersion": "0.13.0",
    "type": "theme",
    "tier": "builtin"
  },
  "capabilities": [],
  "entry": {
    "styles": "./theme.css"
  },
  "contributes": {
    "themes": [{
      "id": "retro",
      "name": "Retro",
      "description": "Classic retro gaming aesthetic",
      "type": "light",
      "tokens": {
        "colours": {
          "primary": "...",
          "secondary": "...",
          "background": "...",
          "surface": "...",
          "text": "...",
          "textMuted": "...",
          "accent": "...",
          "error": "...",
          "success": "...",
          "warning": "..."
        },
        "typography": {
          "fontFamily": "...",
          "fontFamilyMono": "..."
        },
        "borders": {
          "radius": "...",
          "width": "..."
        },
        "shadows": {
          "small": "...",
          "medium": "...",
          "large": "..."
        }
      }
    }]
  }
}
```

#### Modern Theme

**Directory:** `src/plugins/builtin/themes/modern/`
- Same structure as retro
- Migrate from `src/styles/themes/modern.css`

#### Minimal Theme

**Directory:** `src/plugins/builtin/themes/minimal/`
- Same structure as retro
- Migrate from `src/styles/themes/minimal.css`

---

### 3. Mechanic Migration

**Location:** `src/plugins/builtin/mechanics/`

#### Memory Mechanic

**Directory:** `src/plugins/builtin/mechanics/memory/`

**Files:**
- `manifest.json` - Plugin manifest
- `index.ts` - Re-export from existing location
- Existing code stays in `src/mechanics/memory/`

**manifest.json:**
```json
{
  "$schema": "https://itemdeck.app/schemas/plugin/v1.json",
  "id": "org.itemdeck.mechanic-memory",
  "name": "Memory Game",
  "version": "1.0.0",
  "description": "Classic card matching memory game",
  "author": {
    "name": "itemdeck"
  },
  "licence": "GPL-3.0-or-later",
  "itemdeck": {
    "minVersion": "0.13.0",
    "type": "mechanic",
    "tier": "builtin"
  },
  "capabilities": ["storage:local", "ui:overlay"],
  "contributes": {
    "mechanics": [{
      "id": "memory",
      "name": "Memory Match",
      "description": "Find matching pairs of cards",
      "icon": "./assets/memory-icon.svg",
      "category": "puzzle",
      "minCards": 4,
      "maxCards": 52,
      "playerCount": { "min": 1, "max": 1 },
      "difficulty": "easy",
      "entry": "../../../mechanics/memory/index.ts"
    }]
  }
}
```

#### Snap Ranking Mechanic

**Directory:** `src/plugins/builtin/mechanics/snap-ranking/`

**Files:**
- `manifest.json` - Enhance existing `src/mechanics/snap-ranking/manifest.json`
- `index.ts` - Re-export from existing location

**Note:** Snap-ranking already has a manifest.json - extend it to full plugin format.

---

### 4. Source Migration

**Location:** `src/plugins/builtin/sources/`

#### GitHub Source

**Directory:** `src/plugins/builtin/sources/github/`

**Files:**
- `manifest.json` - Plugin manifest
- `gh.json` - Source configuration schema
- `index.ts` - Re-export from existing loaders

**manifest.json:**
```json
{
  "$schema": "https://itemdeck.app/schemas/plugin/v1.json",
  "id": "org.itemdeck.source-github",
  "name": "GitHub Collections",
  "version": "1.0.0",
  "description": "Load collections from GitHub repositories",
  "author": {
    "name": "itemdeck"
  },
  "licence": "GPL-3.0-or-later",
  "itemdeck": {
    "minVersion": "0.13.0",
    "type": "source",
    "tier": "builtin"
  },
  "capabilities": ["fetch:external", "cache:collections"],
  "contributes": {
    "sources": [{
      "id": "github",
      "name": "GitHub",
      "description": "Load collections from GitHub repositories",
      "icon": "./assets/github-icon.svg",
      "config": {
        "schema": {
          "type": "object",
          "required": ["owner"],
          "properties": {
            "owner": {
              "type": "string",
              "description": "GitHub username or organisation"
            },
            "repo": {
              "type": "string",
              "description": "Repository name (optional)"
            },
            "branch": {
              "type": "string",
              "default": "main"
            },
            "path": {
              "type": "string",
              "description": "Path to collection folder"
            }
          }
        }
      },
      "entry": "../../../loaders/githubDiscovery.ts"
    }]
  }
}
```

**gh.json (Source Configuration):**
```json
{
  "$schema": "https://itemdeck.app/schemas/source-config/v1.json",
  "id": "github",
  "name": "GitHub",
  "urlPatterns": [
    "/gh?u={owner}&c={path}",
    "/gh/{owner}/c/{path}"
  ],
  "discovery": {
    "method": "api",
    "endpoint": "https://api.github.com/repos/{owner}/{repo}/contents/{path}"
  },
  "transforms": {
    "supported": ["json"],
    "schema": "./collection.schema.json"
  }
}
```

---

### 5. Legacy Code Removal

**Files to Modify:**

#### src/mechanics/index.ts
- Remove direct `mechanicRegistry.register()` calls
- Replace with plugin-based registration
- Keep mechanic implementations in place (referenced by plugins)

**Before:**
```typescript
mechanicRegistry.register("memory", async () => {
  const { memoryMechanic } = await import("./memory");
  return memoryMechanic;
});
```

**After:**
```typescript
// Mechanics are now registered via plugin system
// This file becomes a re-export of mechanic utilities
export { mechanicRegistry } from './registry';
export type { GameMechanic, MechanicInstance } from './types';
```

#### src/styles/themes/
- Keep CSS files for reference during migration
- After migration validated, mark as deprecated or remove

#### src/config/themeRegistry.ts
- Refactor to use plugin-based themes
- Keep interface compatibility during transition

---

## File Structure After Migration

```
src/plugins/
├── integration/
│   ├── themeAdapter.ts
│   ├── mechanicAdapter.ts
│   ├── settingsAdapter.ts
│   ├── sourceAdapter.ts
│   └── index.ts
└── builtin/
    ├── themes/
    │   ├── retro/
    │   │   ├── manifest.json
    │   │   ├── theme.css
    │   │   └── index.ts
    │   ├── modern/
    │   │   ├── manifest.json
    │   │   ├── theme.css
    │   │   └── index.ts
    │   └── minimal/
    │       ├── manifest.json
    │       ├── theme.css
    │       └── index.ts
    ├── mechanics/
    │   ├── memory/
    │   │   ├── manifest.json
    │   │   └── index.ts
    │   └── snap-ranking/
    │       ├── manifest.json
    │       └── index.ts
    └── sources/
        └── github/
            ├── manifest.json
            ├── gh.json
            └── index.ts
```

---

## Integration Points

### App Initialisation

Update `src/App.tsx` or plugin provider to:
1. Load built-in plugins on mount
2. Apply default theme plugin
3. Register built-in mechanics
4. Register built-in sources

### Theme Context

Update `src/context/SettingsContext.tsx` or theme-related code to:
- Use ThemePluginAdapter instead of direct CSS imports
- Maintain backwards compatibility with existing theme selection UI

### Mechanic Context

Update `src/mechanics/context.tsx` to:
- Use MechanicPluginAdapter for mechanic creation
- Maintain existing mechanic interface

---

## Testing Requirements

Create tests in `tests/plugins/integration/`:
- `themeAdapter.test.ts` - Theme application
- `mechanicAdapter.test.ts` - Mechanic registration
- `sourceAdapter.test.ts` - Source registration

Verify existing functionality:
- All 3 themes render correctly
- Memory game plays correctly
- Snap ranking plays correctly
- GitHub collections load correctly

---

## Success Criteria

- [ ] All 4 adapters implemented and working
- [ ] Retro, Modern, Minimal themes work as plugins
- [ ] Memory mechanic works as plugin
- [ ] Snap-ranking mechanic works as plugin
- [ ] GitHub source works as plugin
- [ ] No regression in existing functionality
- [ ] Legacy registration code removed
- [ ] All tests pass

---

## Notes

- Preserve existing mechanic/theme code - only change how they're registered
- Maintain backwards compatibility during migration
- Test thoroughly before removing legacy code
- Use British English in all documentation and comments
