# Work Package A: Settings Draft State + UI Polish

## Overview

Implement a draft state pattern for settings so changes only apply when the user clicks "Accept", and polish UI consistency across all dialogues and modals.

**Version:** v0.14.0
**Dependencies:** v0.13.0 complete
**Estimated Scope:** ~8 files modified, ~500 lines of code

---

## Context

itemdeck.app currently applies settings changes immediately as users adjust values. This causes:
- Jarring visual changes while exploring options
- Difficulty reverting if user doesn't like a change
- No clear "save" or "cancel" workflow

Additionally, button styling across dialogues/modals is inconsistent, with some buttons missing borders or using inconsistent hierarchy.

---

## Objectives

1. Implement draft state pattern in settingsStore
2. Update SettingsPanel to use draft/commit workflow
3. Improve CacheConsentDialog UX with better copy and button layout
4. Hide active mechanic from selection list (already shown in ACTIVE section)
5. Audit and standardise button styles across all modals/dialogues

---

## Technical Requirements

### 1. Settings Draft State Pattern (F-090)

**Location:** `src/stores/settingsStore.ts`

**Architecture:**

```
+--------------------------------------------------+
| Settings Store                                    |
+--------------------------------------------------+
| committed: SettingsState (persisted)              |
| draft: SettingsState | null                       |
|                                                   |
| startEditing() -> creates draft from committed    |
| updateDraft(partial) -> updates draft only        |
| commitDraft() -> draft -> committed, persist      |
| discardDraft() -> draft = null                    |
|                                                   |
| getEffective() -> draft ?? committed              |
+--------------------------------------------------+
```

**New State Fields:**

```typescript
interface SettingsState {
  // ... existing fields ...

  // Draft state management
  /** Draft copy of settings (null when not editing) */
  _draft: Partial<SettingsState> | null;

  /** Whether draft differs from committed state */
  isDirty: boolean;

  // Draft actions
  startEditing: () => void;
  updateDraft: (partial: Partial<SettingsState>) => void;
  commitDraft: () => void;
  discardDraft: () => void;

  // Effective value selector
  getEffective: <K extends keyof SettingsState>(key: K) => SettingsState[K];
}
```

**Implementation Notes:**

1. `startEditing()`:
   - Creates a shallow copy of relevant settings into `_draft`
   - Called when SettingsPanel opens

2. `updateDraft(partial)`:
   - Merges partial into `_draft`
   - Updates `isDirty` by comparing to committed state
   - Does NOT persist to localStorage

3. `commitDraft()`:
   - Merges `_draft` into main state
   - Triggers persist middleware
   - Clears `_draft` and `isDirty`

4. `discardDraft()`:
   - Clears `_draft`
   - Resets `isDirty` to false

5. `getEffective(key)`:
   - Returns `_draft?.[key] ?? state[key]`
   - Used by UI to show preview values

**Immediate Application Exceptions:**

The following settings MUST apply immediately (bypass draft pattern):
- `highContrast` - Accessibility requirement
- `reduceMotion` - Accessibility requirement

These should call their existing setters directly AND update draft to keep them in sync.

**Partialize Update:**

Update the `partialize` option to exclude draft state from persistence:

```typescript
partialize: (state) => {
  const { _draft, isDirty, ...rest } = state;
  return {
    // ... existing persisted fields ...
  };
}
```

---

### 2. Settings Panel Draft Workflow (F-090)

**Location:** `src/components/SettingsPanel/SettingsPanel.tsx`

**Changes:**

1. **On Open:**
   ```typescript
   useEffect(() => {
     if (isOpen) {
       startEditing();
     }
   }, [isOpen, startEditing]);
   ```

2. **Cancel Button:**
   ```typescript
   const handleCancel = () => {
     discardDraft();
     onClose();
   };
   ```

3. **Accept Button:**
   ```typescript
   const handleAccept = () => {
     commitDraft();
     onClose();
   };
   ```

4. **Dirty State Indicator:**
   Add visual indicator when `isDirty` is true:
   ```tsx
   <footer className={styles.footer}>
     {isDirty && (
       <span className={styles.dirtyIndicator}>
         Unsaved changes
       </span>
     )}
     <div className={styles.footerButtons}>
       {/* ... buttons ... */}
     </div>
   </footer>
   ```

5. **All Settings Tabs:**
   Update all settings components to use `updateDraft()` instead of direct setters:
   - `QuickSettings.tsx`
   - `AppearanceSettingsTabs.tsx`
   - `CardSettingsTabs.tsx`
   - `ThemeSettingsTabs.tsx`
   - `StorageSettingsTabs.tsx`
   - `SystemSettings.tsx`
   - `CollectionsTab.tsx`
   - `DataTab.tsx`

**CSS Updates:**

```css
.dirtyIndicator {
  font-size: 0.875rem;
  colour: var(--colour-warning, #f59e0b);
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.dirtyIndicator::before {
  content: '';
  width: 0.5rem;
  height: 0.5rem;
  background: currentColor;
  border-radius: 50%;
}
```

---

### 3. Cache Consent Dialogue UX (F-092)

**Location:** `src/components/CacheConsentDialog/CacheConsentDialog.tsx`

**Changes:**

1. **Update Info Text:**
   ```tsx
   <div className={styles.info}>
     <span className={styles.infoIcon}>i</span>
     <span>
       Cached data is stored only in this browser on this device.
       It won't sync to other browsers or devices.
     </span>
   </div>
   ```

2. **Reorder Buttons:**
   - Primary: "Allow for this collection" (filled button)
   - Secondary: "Not now" (outline button)
   - Below divider: Text links for global options

   ```tsx
   <div className={styles.actions}>
     {/* Primary action */}
     <button
       className={styles.primaryButton}
       onClick={handleAllowOnce}
     >
       Allow for this collection
     </button>

     {/* Secondary action - outline style */}
     <button
       className={styles.outlineButton}
       onClick={handleDeny}
     >
       Not now
     </button>

     {/* Global options below divider */}
     <div className={styles.divider} />

     <div className={styles.globalOptions}>
       <button
         className={styles.textLink}
         onClick={handleAlwaysAllow}
       >
         Always allow caching
       </button>
       <span className={styles.optionSeparator}>|</span>
       <button
         className={styles.textLink}
         onClick={handleNeverCache}
       >
         Never cache
         <span className={styles.hint}>(can change in Settings)</span>
       </button>
     </div>
   </div>
   ```

3. **CSS Updates:**

   ```css
   .outlineButton {
     background: transparent;
     border: 1px solid var(--colour-border);
     colour: var(--colour-text);
     padding: 0.75rem 1.5rem;
     border-radius: 0.5rem;
     cursor: pointer;
     transition: background-colour 0.2s;
   }

   .outlineButton:hover {
     background: var(--colour-surface-hover);
   }

   .globalOptions {
     display: flex;
     justify-content: center;
     align-items: center;
     gap: 0.5rem;
     font-size: 0.875rem;
   }

   .textLink {
     background: none;
     border: none;
     colour: var(--colour-text-muted);
     cursor: pointer;
     text-decoration: underline;
     font-size: inherit;
   }

   .textLink:hover {
     colour: var(--colour-text);
   }

   .hint {
     colour: var(--colour-text-muted);
     font-size: 0.75rem;
     margin-left: 0.25rem;
   }

   .optionSeparator {
     colour: var(--colour-border);
   }
   ```

---

### 4. Mechanic Panel - Hide Active from List (F-093)

**Location:** `src/components/MechanicPanel/MechanicPanel.tsx`

**Change:**

When rendering the mechanic options list, filter out the currently active mechanic since it already appears in the ACTIVE section:

```tsx
{/* Mechanic options - hide active mechanic (already shown above) */}
{mechanics
  .filter((manifest) => manifest.id !== activeMechanicId)
  .map((manifest) => {
    const Icon = manifest.icon;

    return (
      <button
        key={manifest.id}
        type="button"
        className={styles.mechanicOption}
        onClick={() => { void handlePreSelect(manifest.id); }}
      >
        <div className={styles.mechanicIcon}>
          <Icon />
        </div>
        <div className={styles.mechanicInfo}>
          <div className={styles.mechanicHeader}>
            <span className={styles.mechanicName}>{manifest.name}</span>
            <span className={styles.mechanicVersion}>v{manifest.version}</span>
          </div>
          <span className={styles.mechanicDescription}>
            {manifest.description}
          </span>
          {manifest.minCards && (
            <span className={styles.mechanicRequirement}>
              Requires at least {manifest.minCards} cards
            </span>
          )}
        </div>
      </button>
    );
  })}
```

**Additional Changes:**

1. Remove the `isActive` check and `disabled` prop (no longer needed)
2. Remove the `mechanicOptionActive` class (active mechanic not in list)
3. Remove the `activeMark` span (checkmark no longer needed)

---

### 5. Button Style Consistency Audit (F-094)

**Scope:** All modals and dialogues across the application.

**Standard Button Hierarchy:**

| Level | Name | Style | Use Case |
|-------|------|-------|----------|
| Primary | `primaryButton` | Filled background, contrast text | Main action (Accept, Allow, Start) |
| Secondary | `secondaryButton` / `outlineButton` | Outline border, transparent background | Alternative action (Cancel, Not now) |
| Tertiary | `textButton` / `textLink` | No border, underline on hover | De-emphasised options |

**Files to Audit:**

1. **CacheConsentDialog** (`src/components/CacheConsentDialog/`)
   - Apply hierarchy per F-092 spec above

2. **MechanicPanel** (`src/components/MechanicPanel/`)
   - `stopButton`: Should be secondary (outline) not filled
   - `cancelButton`: Already correct (outline)
   - `startButton`: Already correct (filled primary)

3. **SettingsPanel** (`src/components/SettingsPanel/`)
   - `cancelButton`: Should be secondary (outline)
   - `acceptButton`: Already correct (filled primary)

4. **HelpModal** (`src/components/HelpModal/`)
   - Close button: Icon-only button, correct styling

5. **ConfirmDialog** (`src/components/ConfirmDialog/`)
   - Audit confirm/cancel button styling

6. **QueryErrorBoundary** (`src/components/QueryErrorBoundary/`)
   - "Different Game" button: Add border (currently no border)
   - Retry/refresh buttons: Should follow hierarchy

7. **CollectionPicker** (`src/components/CollectionPicker/`)
   - Audit any action buttons

8. **SourcesOverlay** (`src/components/SourcesOverlay/`)
   - Audit button consistency

**Shared Button Styles:**

Create or update shared button CSS classes in a central location (e.g., `src/styles/buttons.css` or within component modules):

```css
/* Primary - Main action */
.buttonPrimary {
  background: var(--colour-primary);
  colour: var(--colour-text-on-primary, #fff);
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 0.5rem;
  font-weight: 500;
  cursor: pointer;
  transition: opacity 0.2s;
}

.buttonPrimary:hover {
  opacity: 0.9;
}

.buttonPrimary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Secondary - Alternative action */
.buttonSecondary {
  background: transparent;
  colour: var(--colour-text);
  border: 1px solid var(--colour-border);
  padding: 0.75rem 1.5rem;
  border-radius: 0.5rem;
  font-weight: 500;
  cursor: pointer;
  transition: background-colour 0.2s;
}

.buttonSecondary:hover {
  background: var(--colour-surface-hover);
}

.buttonSecondary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Tertiary - De-emphasised action */
.buttonTertiary {
  background: none;
  border: none;
  colour: var(--colour-text-muted);
  padding: 0.5rem;
  cursor: pointer;
  text-decoration: underline;
  text-underline-offset: 2px;
}

.buttonTertiary:hover {
  colour: var(--colour-text);
}
```

---

## File Structure

```
src/
+-- stores/
|   +-- settingsStore.ts           # Add draft state management
+-- components/
|   +-- SettingsPanel/
|   |   +-- SettingsPanel.tsx      # Draft workflow integration
|   |   +-- SettingsPanel.module.css  # Dirty indicator styles
|   |   +-- QuickSettings.tsx      # Use updateDraft
|   |   +-- AppearanceSettingsTabs.tsx  # Use updateDraft
|   |   +-- (other tabs...)        # Use updateDraft
|   +-- CacheConsentDialog/
|   |   +-- CacheConsentDialog.tsx    # UX improvements
|   |   +-- CacheConsentDialog.module.css  # Button styles
|   +-- MechanicPanel/
|   |   +-- MechanicPanel.tsx      # Filter active from list
|   +-- QueryErrorBoundary/
|   |   +-- QueryErrorBoundary.tsx    # Button styling
|   |   +-- QueryErrorBoundary.module.css  # Button styles
|   +-- ConfirmDialog/
|       +-- ConfirmDialog.tsx      # Button audit
+-- styles/
    +-- buttons.css                # (Optional) Shared button styles
```

---

## Integration Points

### Settings Context

Components consuming settings via `useSettingsStore` should use `getEffective()` for preview values when the settings panel is open:

```typescript
// In components that need to preview settings changes
const getEffective = useSettingsStore((s) => s.getEffective);
const theme = getEffective('visualTheme');
```

### Theme Application

The theme system should read from effective settings (draft if editing, committed otherwise) to enable live preview:

```typescript
// In theme application hook/effect
const getEffective = useSettingsStore((s) => s.getEffective);
const visualTheme = getEffective('visualTheme');
// Apply theme...
```

---

## Testing Requirements

### Unit Tests

Create/update tests in `tests/stores/`:

**`settingsStore.draft.test.ts`:**
```typescript
describe('Settings Draft State', () => {
  it('should create draft from committed state on startEditing', () => {});
  it('should update draft without affecting committed state', () => {});
  it('should set isDirty when draft differs from committed', () => {});
  it('should merge draft into committed on commitDraft', () => {});
  it('should clear draft on discardDraft', () => {});
  it('should return draft value from getEffective when editing', () => {});
  it('should return committed value from getEffective when not editing', () => {});
  it('should apply accessibility settings immediately', () => {});
  it('should not persist draft state to localStorage', () => {});
});
```

### Component Tests

**`SettingsPanel.test.tsx`:**
```typescript
describe('SettingsPanel Draft Workflow', () => {
  it('should call startEditing when panel opens', () => {});
  it('should call discardDraft when Cancel is clicked', () => {});
  it('should call commitDraft when Accept is clicked', () => {});
  it('should show dirty indicator when isDirty is true', () => {});
});
```

**`CacheConsentDialog.test.tsx`:**
```typescript
describe('CacheConsentDialog', () => {
  it('should display updated info text', () => {});
  it('should have primary button for Allow', () => {});
  it('should have outline button for Not now', () => {});
  it('should show settings hint on Never cache option', () => {});
});
```

**`MechanicPanel.test.tsx`:**
```typescript
describe('MechanicPanel', () => {
  it('should not show active mechanic in selection list', () => {});
  it('should show active mechanic in ACTIVE section', () => {});
});
```

---

## Success Criteria

- [ ] Settings changes only apply when Accept is clicked
- [ ] Cancel reverts all changes made during session
- [ ] Dark Mode and High Contrast apply immediately (accessibility exception)
- [ ] Draft state not persisted to localStorage
- [ ] Dirty indicator appears when changes are pending
- [ ] Cache consent dialogue has improved copy and button layout
- [ ] "(can change in Settings)" hint appears on Never cache option
- [ ] Active mechanic not duplicated in selection list
- [ ] All modals/dialogues use consistent button hierarchy
- [ ] All buttons have appropriate borders/styling
- [ ] All existing tests pass
- [ ] New tests pass

---

## Notes

- Follow existing code patterns in the codebase
- Use British English in all documentation and comments
- Maintain TypeScript strict mode compliance
- Consider mobile viewport when testing UI changes
- Test accessibility settings (Dark Mode, High Contrast) apply immediately
