# Work Package B: Competing Mechanic (Top Trumps)

## Overview

Implement a card-versus-card stat comparison game inspired by Top Trumps. Players compete against a CPU opponent, selecting stats from their cards to win rounds and capture cards.

**Version:** v0.14.0
**Feature:** F-059 Competing Mechanic
**Dependencies:** v0.13.0 (Plugin Architecture)
**Estimated Scope:** ~15 new files, ~1200 lines of code

---

## Context

itemdeck.app now has a plugin-based mechanic system (v0.13.0) with two working mechanics:
- Memory Game (`src/mechanics/memory/`)
- Snap Ranking (`src/mechanics/snap-ranking/`)

Both mechanics demonstrate the patterns to follow:
- `manifest.json` for plugin metadata
- `index.tsx` implementing the `Mechanic<TSettings>` interface
- `store.ts` for Zustand state management
- `types.ts` for TypeScript definitions
- `components.tsx` for UI components
- `Settings.tsx` for mechanic configuration

The Competing mechanic extends this with:
- Two-player game flow (player vs CPU)
- AI opponent with multiple difficulty levels
- Numeric field detection and stat-based comparison
- Card ownership tracking (deck splitting)

---

## Objectives

1. Create a complete Top Trumps-style mechanic following existing patterns
2. Implement three AI difficulty levels (Simple, Medium, Hard)
3. Auto-detect numeric fields suitable for stat comparison
4. Provide engaging battle UI with card-versus-card display
5. Track and display game progress (card counts, round results)

---

## Technical Requirements

### 1. Game Flow

**Setup Phase:**
1. Validate collection has at least one numeric field
2. Detect all numeric fields for stat selection
3. Shuffle deck and deal cards evenly to player and CPU
4. Odd card (if any) goes to tie pile

**Battle Round:**
1. Player sees their top card (face up)
2. CPU card is visible but stats are hidden
3. Player selects a stat from their card
4. CPU card reveals, comparison occurs
5. Winner takes both cards (added to bottom of winner's deck)
6. Turn alternates (next round: CPU selects stat)

**Tie Handling:**
- When stats are equal, both cards go to a tie pile
- Winner of next round takes all tie pile cards
- If game ends with tie pile, split evenly

**Win Conditions:**
- One player has all cards (knockout)
- After N rounds (configurable), most cards wins
- Draw if equal cards at limit

---

### 2. Numeric Field Detection

**Location:** `src/mechanics/competing/utils/numericFields.ts`

**Requirements:**
- Scan collection data to find numeric fields
- Support both integer and float values
- Handle string values that parse as numbers
- Exclude ID fields and obvious non-stats (timestamps, etc.)
- Return field metadata including:
  - Field name/key
  - Display label (humanise field name)
  - Value range (min, max)
  - Whether higher is better (default: true)

**Interface:**
```typescript
interface NumericFieldInfo {
  key: string;
  label: string;
  min: number;
  max: number;
  higherIsBetter: boolean;
}

function detectNumericFields(cards: CardData[]): NumericFieldInfo[];
function getCardValue(card: CardData, fieldKey: string): number | null;
```

**Detection Algorithm:**
1. For each card, examine all fields
2. Track which fields are consistently numeric across cards
3. Require at least 80% of cards to have valid numeric values
4. Exclude fields with identical values across all cards
5. Sort by value variance (more interesting stats first)

---

### 3. AI Opponent

**Location:** `src/mechanics/competing/ai/`

**Difficulty Levels:**

#### Simple AI (`simple.ts`)
- Randomly selects a stat from available options
- No strategy or pattern tracking
- Good for beginners

**Interface:**
```typescript
interface AIStrategy {
  selectStat(
    cpuCard: CardData,
    numericFields: NumericFieldInfo[],
    gameContext: GameContext
  ): string; // Returns field key to compare
}
```

#### Medium AI (`medium.ts`)
- Selects the stat where CPU card has highest relative value
- Normalises values based on field ranges
- No tracking of player behaviour

**Strategy:**
```typescript
// For each numeric field, calculate relative strength
const relativeStrength = (value - min) / (max - min);
// Select field with highest relative strength
```

#### Hard AI (`hard.ts`)
- Tracks player's stat selection patterns
- Predicts which stat player will choose
- Selects stat to counter predicted choice
- Falls back to Medium strategy when uncertain

**Pattern Tracking:**
```typescript
interface PatternTracker {
  recordSelection(fieldKey: string): void;
  predictNextSelection(): string | null;
  getSelectionHistory(): Map<string, number>;
}
```

**Counter Strategy:**
- If player consistently picks a stat, prepare counter
- Counter: Select stat where CPU is strong AND player's preferred stat shows weakness
- Weight recent selections more heavily (exponential decay)

---

### 4. State Management

**Location:** `src/mechanics/competing/store.ts`

**State Shape:**
```typescript
interface CompetingState extends MechanicState {
  // Game status
  isActive: boolean;
  phase: GamePhase;

  // Configuration
  difficulty: Difficulty;
  roundLimit: number; // 0 = no limit (knockout only)

  // Decks
  playerDeck: string[]; // Card IDs
  cpuDeck: string[];
  tiePile: string[];

  // Current round
  currentRound: number;
  currentTurn: 'player' | 'cpu';
  playerCard: string | null;
  cpuCard: string | null;
  selectedStat: string | null;
  roundResult: RoundResult | null;

  // Stats
  roundsWon: { player: number; cpu: number };
  cardsWon: { player: number; cpu: number };

  // Timing
  gameStartedAt: number;
  gameEndedAt: number | null;

  // Field data
  numericFields: NumericFieldInfo[];
  cardData: Map<string, CardData>;

  // AI state
  aiPatternTracker: PatternTracker | null;

  // Error state
  errorMessage: string | null;
}

type GamePhase =
  | 'setup'           // Preparing game
  | 'player_select'   // Player choosing stat
  | 'cpu_select'      // CPU choosing stat
  | 'reveal'          // Showing comparison
  | 'collecting'      // Animating card collection
  | 'round_end'       // Brief pause between rounds
  | 'game_over';      // Game complete

type Difficulty = 'simple' | 'medium' | 'hard';

interface RoundResult {
  winner: 'player' | 'cpu' | 'tie';
  playerValue: number;
  cpuValue: number;
  stat: string;
  cardsWon: number;
}
```

**Actions:**
```typescript
interface CompetingActions {
  // Lifecycle
  activate: () => void;
  deactivate: () => void;
  initGame: (config: GameConfig) => void;
  resetGame: () => void;

  // Game actions
  selectStat: (fieldKey: string) => void;
  revealAndCompare: () => void;
  collectCards: () => void;
  nextRound: () => void;

  // AI
  cpuSelectStat: () => void;

  // Settings
  setDifficulty: (difficulty: Difficulty) => void;
  setRoundLimit: (limit: number) => void;

  // Queries
  getWinner: () => 'player' | 'cpu' | 'draw' | null;
  isGameOver: () => boolean;
  getProgress: () => { playerCards: number; cpuCards: number; round: number };
}
```

---

### 5. UI Components

**Location:** `src/mechanics/competing/components.tsx` or `src/mechanics/competing/components/`

#### Battle Overlay

Main game interface showing:
- Player card (left side, face up, stats visible)
- CPU card (right side, face up, stats hidden until reveal)
- Stat selection buttons on player card
- Card count displays for both players
- Round counter and result display
- Tie pile indicator (when active)

**Layout:**
```
┌─────────────────────────────────────────────────────────┐
│  Round 5                              Player: 12  CPU: 8 │
├────────────────────────────────────────────────────────-┤
│                                                          │
│    ┌─────────────┐          ┌─────────────┐             │
│    │             │    VS    │             │             │
│    │   PLAYER    │          │     CPU     │             │
│    │    CARD     │          │    CARD     │             │
│    │             │          │             │             │
│    │  [Attack]   │          │     ???     │             │
│    │  [Defence]  │          │     ???     │             │
│    │  [Speed]    │          │     ???     │             │
│    └─────────────┘          └─────────────┘             │
│                                                          │
│                    [Tie Pile: 2]                         │
├─────────────────────────────────────────────────────────┤
│              Select a stat to compare!                   │
└─────────────────────────────────────────────────────────┘
```

#### Stat Selection Buttons

- Show stat name and player's value
- Highlight on hover
- Disable during CPU turn or reveal phase
- Visual feedback on selection

**Styling:**
```css
.statButton {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 1rem;
  border: 2px solid var(--colour-border);
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: all 0.2s;
}

.statButton:hover:not(:disabled) {
  border-color: var(--colour-primary);
  background: var(--colour-surface-hover);
}

.statButton:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
```

#### Reveal Animation

When stats are compared:
1. CPU stat values fade in
2. Selected stat highlights on both cards
3. Values animate/pulse
4. Winner indicator appears (glow, checkmark)
5. Cards animate towards winner's deck

**CSS Animation Classes:**
- `.revealing` - Fade in CPU stats
- `.comparing` - Pulse selected stat values
- `.winner` - Highlight winning card
- `.loser` - Dim losing card
- `.collecting` - Animate cards moving

#### Round Result Display

Shows after each comparison:
- "You Win!" / "CPU Wins!" / "It's a Tie!"
- Stat comparison: "Attack: 85 vs 72"
- Cards won indicator
- Brief pause before next round

#### Game Over Screen

Shows when game ends:
- Winner announcement (large text)
- Final score (cards won, rounds won)
- Game statistics:
  - Total rounds played
  - Time elapsed
  - Biggest win margin
- "Play Again" button

---

### 6. Settings Panel

**Location:** `src/mechanics/competing/Settings.tsx`

**Settings:**
```typescript
interface CompetingSettings {
  difficulty: Difficulty;
  roundLimit: RoundLimitOption;
  showCpuThinking: boolean; // Brief delay when CPU selects
  autoAdvance: boolean;     // Auto-start next round
}

type RoundLimitOption = 0 | 10 | 20 | 30 | 50; // 0 = no limit
```

**UI:**
- Difficulty selector (radio buttons or segmented control)
- Round limit dropdown
- Toggle for CPU thinking delay
- Toggle for auto-advance

**Difficulty Descriptions:**
- Simple: "CPU picks randomly. Good for learning."
- Medium: "CPU picks its best stat. A fair challenge."
- Hard: "CPU learns your patterns. Expert mode."

---

### 7. Mechanic Entry Point

**Location:** `src/mechanics/competing/index.tsx`

**Implementation:**
```typescript
import { useCompetingStore } from "./store";
import { BattleOverlay, GridOverlay } from "./components";
import { CompetingSettingsPanel } from "./Settings";
import { DEFAULT_SETTINGS } from "./types";
import type { Mechanic, CardActions } from "../types";
import type { CompetingSettings } from "./types";

function CompetingIcon({ className }: { className?: string }) {
  return (
    <svg className={className} viewBox="0 0 24 24" /* ... */>
      {/* Crossed swords or VS icon */}
    </svg>
  );
}

export const competingMechanic: Mechanic<CompetingSettings> = {
  manifest: {
    id: "competing",
    name: "Top Trumps",
    description: "Battle card vs card! Compare stats against a CPU opponent to win all the cards.",
    icon: CompetingIcon,
    version: "1.0.0",
    minCards: 4,
  },

  lifecycle: {
    onActivate: () => useCompetingStore.getState().activate(),
    onDeactivate: () => useCompetingStore.getState().deactivate(),
    onReset: () => useCompetingStore.getState().resetGame(),
  },

  getState: () => useCompetingStore.getState(),
  subscribe: (listener) => useCompetingStore.subscribe(listener),

  getCardActions: (): CardActions => ({
    // Cards are displayed via overlay, no direct click interaction
    canInteract: () => false,
  }),

  CardOverlay: undefined, // Battle uses grid overlay only
  GridOverlay: BattleOverlay,
  Settings: CompetingSettingsPanel,

  defaultSettings: DEFAULT_SETTINGS,
  getSettings: () => {
    const state = useCompetingStore.getState();
    return {
      difficulty: state.difficulty,
      roundLimit: state.roundLimit,
      // ...
    };
  },
  setSettings: (settings) => {
    const store = useCompetingStore.getState();
    if (settings.difficulty) store.setDifficulty(settings.difficulty);
    if (settings.roundLimit !== undefined) store.setRoundLimit(settings.roundLimit);
  },
};
```

---

### 8. Manifest

**Location:** `src/mechanics/competing/manifest.json`

```json
{
  "id": "competing",
  "name": "Top Trumps",
  "version": "1.0.0",
  "description": "Battle your cards against a CPU opponent. Compare stats - highest value wins! Capture all cards to claim victory.",
  "entrypoint": "./index.tsx",
  "minCards": 4,
  "author": {
    "name": "itemdeck",
    "url": "https://github.com/itemdeck"
  },
  "keywords": ["battle", "versus", "stats", "comparison", "top-trumps", "game"],
  "licence": "GPL-3.0"
}
```

---

## File Structure

```
src/mechanics/competing/
├── manifest.json
├── index.tsx
├── store.ts
├── types.ts
├── components.tsx           # Or components/ directory
├── Settings.tsx
├── Competing.module.css
├── ai/
│   ├── index.ts             # AI strategy exports
│   ├── types.ts             # AI interfaces
│   ├── simple.ts            # Random selection
│   ├── medium.ts            # Best stat selection
│   └── hard.ts              # Pattern tracking
└── utils/
    ├── index.ts
    └── numericFields.ts     # Field detection
```

---

## Integration Points

### src/mechanics/index.ts

Add competing mechanic to exports:
```typescript
export { competingMechanic } from "./competing";
```

### src/mechanics/registry.ts

Register the mechanic factory:
```typescript
mechanicRegistry.register("competing", async () => {
  const { competingMechanic } = await import("./competing");
  return competingMechanic;
});
```

### Collection Validation

The mechanic should gracefully handle:
- Collections with no numeric fields (show error, don't crash)
- Collections with < 4 cards (show error)
- Cards missing numeric values (exclude from stat options)

---

## Testing Requirements

Create tests in `tests/mechanics/competing/`:

### Unit Tests

**`numericFields.test.ts`:**
- Detects numeric fields correctly
- Handles mixed types (string numbers)
- Excludes non-stat fields
- Handles edge cases (empty, all same value)

**`ai/simple.test.ts`:**
- Returns valid stat key
- Distribution is roughly uniform over many calls

**`ai/medium.test.ts`:**
- Selects highest relative value stat
- Handles edge cases (all same, missing values)

**`ai/hard.test.ts`:**
- Tracks player selections
- Predicts based on history
- Falls back to medium when uncertain

**`store.test.ts`:**
- Game initialisation
- Round flow (select -> reveal -> collect)
- Win detection (knockout, round limit)
- Tie pile handling
- State transitions

### Integration Tests

**`competing.integration.test.ts`:**
- Full game playthrough
- Mechanic activation/deactivation
- Settings persistence
- Error handling for invalid collections

---

## Success Criteria

- [ ] Numeric field detection works for all collection types
- [ ] All three AI difficulty levels work correctly
- [ ] Game flow is smooth and intuitive
- [ ] Tie pile handling works correctly
- [ ] Win conditions trigger appropriately
- [ ] Settings panel allows all configuration
- [ ] Visual feedback is clear and responsive
- [ ] Battle overlay displays correctly on all screen sizes
- [ ] Animations are smooth and non-blocking
- [ ] Error states handled gracefully
- [ ] All tests pass
- [ ] TypeScript strict mode compliant
- [ ] British English in all user-facing text

---

## Notes

- Follow existing mechanic patterns from Memory and Snap Ranking
- Use CSS modules for component styling
- Ensure accessibility (keyboard navigation, screen reader support)
- Consider mobile touch interactions
- Keep AI response time reasonable (< 500ms for Hard difficulty)
- Use British English: "colour", "defence", "behaviour"

---

## Related Documentation

- [v0.14.0 Milestone](../../../../development/roadmap/milestones/v0.14.0.md)
- [F-059 Feature Specification](../../../../development/roadmap/features/planned/F-059-competing-mechanic.md)
- [Memory Mechanic Reference](../../src/mechanics/memory/)
- [Snap Ranking Mechanic Reference](../../src/mechanics/snap-ranking/)
- [Mechanic Types](../../src/mechanics/types.ts)
