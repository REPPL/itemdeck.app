# Work Package C: Quiz Mechanic

## Overview

Implement a quiz mechanic (F-060) that tests user knowledge of the collection through auto-generated questions with multiple answer formats.

**Version:** v0.14.0
**Feature:** F-060 Quiz Mechanic
**Dependencies:** v0.13.0 (Plugin Architecture)
**Estimated Scope:** ~900 lines of code

---

## Context

itemdeck.app is a React/TypeScript card collection viewer. The mechanics system supports gaming overlays that transform viewing into interactive gameplay.

**Existing Mechanics:**
- Memory (`src/mechanics/memory/`) - Classic card matching game
- Snap Ranking (`src/mechanics/snap-ranking/`) - Field value guessing game

This work package adds a quiz mechanic that generates questions from card data.

---

## Objectives

1. Create question generators for three question types
2. Implement scoring system with streak tracking
3. Build quiz overlay with progress indicator
4. Create results screen with score comparison
5. Support configurable difficulty and question count

---

## Technical Requirements

### 1. Question Types

**Image to Name:**
- Show card image
- Display 4 title options (1 correct, 3 wrong)
- Wrong answers drawn from other cards in collection

**Name to Image:**
- Show card title text
- Display 4 image options (1 correct, 3 wrong)
- Wrong answers drawn from other cards in collection

**Fill the Blank:**
- Show sentence like "Card X was released in ____"
- Display 4 options for the blank (year, category, etc.)
- Uses fields with discrete values (dates, categories, rarities)

---

### 2. Question Generation

**Location:** `src/mechanics/quiz/generators/`

**Requirements:**
- Generate questions from current collection cards
- Ensure wrong answers are plausible (same collection)
- Randomise answer positions (correct answer not always first)
- Avoid duplicate questions in same quiz session
- Handle collections with limited cards (minimum 4 for multiple choice)

**Generator Interface:**
```typescript
interface Question {
  id: string;
  type: 'imageToName' | 'nameToImage' | 'fillTheBlank';
  prompt: string;
  correctAnswer: Answer;
  wrongAnswers: Answer[];
  relatedCardId: string;
  metadata?: {
    field?: string;        // For fill-the-blank
    imageUrl?: string;     // For image-to-name
    correctImageUrl?: string; // For name-to-image
  };
}

interface Answer {
  id: string;
  label: string;
  imageUrl?: string; // For name-to-image
}

interface QuestionGenerator {
  generate(cards: CardData[], count: number): Question[];
  canGenerate(cards: CardData[]): boolean;
}
```

---

### 3. Scoring System

**Scoring Rules:**
- Correct answer: +10 points
- Streak bonus: +2 points per streak level (max +10)
- Wrong answer: 0 points, resets streak
- Skipped: 0 points, resets streak

**Streak Calculation:**
```typescript
function calculateScore(isCorrect: boolean, currentStreak: number): {
  score: number;
  newStreak: number;
} {
  if (!isCorrect) {
    return { score: 0, newStreak: 0 };
  }

  const streakBonus = Math.min(currentStreak * 2, 10);
  return {
    score: 10 + streakBonus,
    newStreak: currentStreak + 1,
  };
}
```

---

### 4. Quiz Store (Zustand)

**Location:** `src/mechanics/quiz/store.ts`

**State Shape:**
```typescript
interface QuizState extends MechanicState {
  isActive: boolean;

  // Quiz configuration
  questionCount: QuestionCountOption;
  enabledQuestionTypes: QuestionType[];
  timerMode: boolean;

  // Game state
  questions: Question[];
  currentIndex: number;
  answers: AnswerRecord[];
  score: number;
  streak: number;
  maxStreak: number;

  // Timing
  quizStartedAt: number;
  quizEndedAt: number | null;
  questionStartedAt: number;

  // Feedback state
  feedbackVisible: boolean;
  lastAnswerCorrect: boolean | null;
}

interface AnswerRecord {
  questionId: string;
  selectedAnswerId: string | null; // null = skipped
  isCorrect: boolean;
  timeToAnswer: number;
  pointsEarned: number;
}
```

**Actions:**
```typescript
interface QuizActions {
  // Lifecycle
  activate: () => void;
  deactivate: () => void;
  startQuiz: (cards: CardData[]) => void;
  resetQuiz: () => void;

  // Game actions
  submitAnswer: (answerId: string) => void;
  skipQuestion: () => void;
  nextQuestion: () => void;
  dismissFeedback: () => void;

  // Settings
  setQuestionCount: (count: QuestionCountOption) => void;
  setEnabledQuestionTypes: (types: QuestionType[]) => void;
  setTimerMode: (enabled: boolean) => void;

  // Computed
  getCurrentQuestion: () => Question | null;
  getProgress: () => { current: number; total: number };
  isQuizComplete: () => boolean;
  getResults: () => QuizResults;
}
```

---

### 5. Quiz Settings

**Location:** `src/mechanics/quiz/Settings.tsx`

**Configuration Options:**
| Setting | Type | Default | Options |
|---------|------|---------|---------|
| questionCount | select | 10 | 5, 10, 20 |
| questionTypes | checkboxes | all | imageToName, nameToImage, fillTheBlank |
| timerMode | toggle | false | - |

**Settings Interface:**
```typescript
interface QuizSettings {
  questionCount: 5 | 10 | 20;
  enabledQuestionTypes: QuestionType[];
  timerMode: boolean;
}

const DEFAULT_SETTINGS: QuizSettings = {
  questionCount: 10,
  enabledQuestionTypes: ['imageToName', 'nameToImage', 'fillTheBlank'],
  timerMode: false,
};
```

---

### 6. UI Components

**Location:** `src/mechanics/quiz/components/`

#### QuizOverlay.tsx
- Full-screen overlay replacing grid during quiz
- Contains question display, answer options, progress

#### QuestionDisplay.tsx
- Shows current question based on type
- Image display for image-to-name
- Text display for name-to-image and fill-the-blank

#### AnswerOptions.tsx
- 4 answer buttons (A, B, C, D)
- Image grid for name-to-image type
- Text buttons for other types
- Highlight correct/incorrect after answer

#### ResultsScreen.tsx
- Final score with percentage
- Streak statistics (max, average)
- Time taken (if timer mode)
- Breakdown of correct/incorrect
- "Play Again" and "Exit" buttons

#### ProgressIndicator.tsx
- Question X of Y display
- Score counter
- Current streak with flame indicator

---

### 7. Timer Mode (Optional)

When timer mode is enabled:
- Show countdown per question (15 seconds default)
- Auto-skip when time expires
- Bonus points for fast answers

**Timer Scoring:**
```typescript
function calculateTimerBonus(timeToAnswer: number): number {
  const QUESTION_TIME = 15000; // 15 seconds
  if (timeToAnswer < 3000) return 5;   // Under 3s: +5
  if (timeToAnswer < 6000) return 3;   // Under 6s: +3
  if (timeToAnswer < 10000) return 1;  // Under 10s: +1
  return 0;
}
```

---

## File Structure

```
src/mechanics/quiz/
├── manifest.json           # Plugin metadata
├── index.tsx               # Entry point, implements Mechanic interface
├── store.ts                # Zustand state management
├── types.ts                # TypeScript types
├── Settings.tsx            # Quiz settings panel
├── Quiz.module.css         # Scoped styles
├── components/
│   ├── index.ts            # Barrel exports
│   ├── QuizOverlay.tsx     # Full-screen quiz overlay
│   ├── QuestionDisplay.tsx # Question rendering
│   ├── AnswerOptions.tsx   # Answer buttons/images
│   ├── ResultsScreen.tsx   # Final score display
│   └── ProgressIndicator.tsx
└── generators/
    ├── index.ts            # Generator exports
    ├── types.ts            # Generator type definitions
    ├── imageToName.ts      # Image to name questions
    ├── nameToImage.ts      # Name to image questions
    ├── fillTheBlank.ts     # Fill the blank questions
    └── utils.ts            # Shared utilities (shuffling, selection)
```

---

## Integration Points

### Mechanic Registry

Register quiz mechanic in `src/mechanics/index.ts`:
```typescript
import { quizMechanic } from './quiz';

export const mechanics = [
  memoryMechanic,
  snapRankingMechanic,
  quizMechanic,
];
```

### Card Data Access

Use collection context for card data:
```typescript
import { useCollectionStore } from '@/stores/collectionStore';

const cards = useCollectionStore((state) => state.cards);
```

### Image Loading

Use existing `ImageWithFallback` component for card images in questions.

---

## Testing Requirements

**Location:** `tests/mechanics/quiz/`

### Unit Tests

**`generators/imageToName.test.ts`:**
- Generates correct number of questions
- All answers from same collection
- Correct answer included
- Handles small collections gracefully

**`generators/nameToImage.test.ts`:**
- Generates correct number of questions
- Images properly assigned
- Handles missing images

**`generators/fillTheBlank.test.ts`:**
- Uses appropriate fields
- Values are plausible
- Handles missing field data

**`store.test.ts`:**
- Initial state correct
- Submit answer updates score/streak
- Skip resets streak
- Quiz completion triggers results

**`scoring.test.ts`:**
- Base score calculation
- Streak bonus calculation
- Timer bonus calculation

### Component Tests

**`QuizOverlay.test.tsx`:**
- Renders question correctly
- Answer selection works
- Progress updates
- Results shown on completion

**`ResultsScreen.test.tsx`:**
- Displays final score
- Shows correct statistics
- Play again button works

### Integration Tests

- Complete quiz flow with scoring
- Question type switching
- Timer mode functionality

---

## Success Criteria

- [ ] All three question types generate correctly
- [ ] Wrong answers are plausible (from same collection)
- [ ] Score tracking is accurate
- [ ] Streak counter increments and resets correctly
- [ ] Maximum streak is tracked
- [ ] Quiz configuration works (count, types, timer)
- [ ] Progress indicator shows correct position
- [ ] Results screen displays accurate statistics
- [ ] Timer mode works when enabled
- [ ] Minimum card requirement enforced (4+ cards)
- [ ] All tests passing
- [ ] TypeScript strict mode compliant
- [ ] British English in all user-facing text

---

## UI/UX Considerations

### Feedback Timing
- Show correct/incorrect feedback for 1.5 seconds
- Auto-advance to next question after feedback
- Allow clicking to dismiss feedback early

### Accessibility
- Keyboard navigation (A/B/C/D keys for answers)
- Focus management between questions
- Screen reader announcements for results
- High contrast answer indicators

### Responsive Design
- Answer buttons stack on mobile
- Image options in 2x2 grid on narrow screens
- Full-width on desktop

---

## Notes

- Follow existing patterns from `src/mechanics/snap-ranking/`
- Use British English throughout (e.g., "colour" not "color")
- Maintain TypeScript strict mode compliance
- No new npm dependencies required
- Ensure proper cleanup on deactivation

---

## Related Documentation

- [F-060 Quiz Mechanic](../../../development/roadmap/features/planned/F-060-quiz-mechanic.md)
- [v0.14.0 Milestone](../../../development/roadmap/milestones/v0.14.0.md)
- [v0.14.0 Implementation Overview](./README.md)
- [Snap Ranking Implementation](../../src/mechanics/snap-ranking/)
- [ADR-017 Mechanic State Management](../../../development/decisions/adrs/ADR-017-mechanic-state-management.md)
