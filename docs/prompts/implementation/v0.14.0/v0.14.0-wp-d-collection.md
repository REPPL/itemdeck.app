# Work Package D: Collection Mechanic

## Overview

Implement the Collection Mechanic that allows users to track which items they own and which they want to acquire. This mechanic validates the plugin architecture with a persistent, non-game mechanic.

**Version:** v0.14.0
**Feature:** F-058
**Dependencies:** v0.13.0 Plugin Architecture (complete)
**Estimated Scope:** ~600 lines, ~8 new files

---

## Context

itemdeck.app currently has two game mechanics (Memory, Snap Ranking). The Collection mechanic is different:

- **Not a game** - It's a tracking tool
- **Persistent state** - Ownership data persists across sessions
- **No "game over"** - Progress accumulates over time
- **Real-world use** - Designed for tracking physical collections

This mechanic follows the established patterns from `src/mechanics/memory/` and `src/mechanics/snap-ranking/`.

---

## Objectives

1. Create Collection mechanic following plugin-compatible structure
2. Implement owned/wishlist state per card with localStorage persistence
3. Create card overlay showing ownership badges
4. Create grid overlay showing collection progress
5. Implement export/import functionality
6. Add keyboard shortcuts for quick toggling
7. Register mechanic with registry

---

## Technical Requirements

### 1. Mechanic Structure

**Directory:** `src/mechanics/collection/`

**Files to create:**
```
collection/
├── manifest.json              # Plugin manifest
├── index.tsx                  # Mechanic entry point
├── store.ts                   # Ownership state (Zustand)
├── types.ts                   # TypeScript types
├── components/
│   ├── CollectionCardOverlay.tsx   # Owned/wishlist badges
│   ├── CollectionGridOverlay.tsx   # Progress bar
│   └── CollectionExport.tsx        # Export/import UI
├── Settings.tsx               # Mechanic settings
└── collection.module.css      # Scoped styles
```

---

### 2. Manifest (manifest.json)

```json
{
  "$schema": "https://itemdeck.app/schemas/mechanic/v1.json",
  "id": "collection",
  "name": "Collection Tracker",
  "description": "Track which items you own and which you want to acquire",
  "version": "1.0.0",
  "icon": "collection",
  "minCards": 1
}
```

---

### 3. Types (types.ts)

```typescript
/**
 * Collection mechanic types.
 */

/** Ownership status for a card */
export type OwnershipStatus = 'none' | 'owned' | 'wishlist';

/** Collection state per source */
export interface CollectionState {
  /** Card IDs marked as owned */
  ownedIds: Set<string>;
  /** Card IDs on wishlist */
  wishlistIds: Set<string>;
}

/** Collection mechanic settings */
export interface CollectionSettings {
  /** Show progress bar in grid overlay */
  showProgress: boolean;
  /** Show badge on unowned cards */
  showUnownedBadge: boolean;
  /** Enable keyboard shortcuts */
  keyboardShortcuts: boolean;
}

/** Collection statistics */
export interface CollectionStats {
  total: number;
  owned: number;
  wishlist: number;
  remaining: number;
  percentComplete: number;
}

/** Export format */
export interface CollectionExport {
  version: '1.0';
  sourceId: string;
  exportedAt: string;
  owned: string[];
  wishlist: string[];
}
```

---

### 4. Store (store.ts)

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import type { CollectionState, CollectionSettings, OwnershipStatus } from './types';

interface CollectionStore {
  // Per-source collection state
  collections: Map<string, CollectionState>;

  // Settings
  settings: CollectionSettings;

  // Active state
  isActive: boolean;
  activeSourceId: string | null;

  // Actions
  activate: (sourceId: string) => void;
  deactivate: () => void;

  // Ownership actions
  setOwnership: (cardId: string, status: OwnershipStatus) => void;
  toggleOwned: (cardId: string) => void;
  toggleWishlist: (cardId: string) => void;
  getStatus: (cardId: string) => OwnershipStatus;

  // Batch actions
  markAllOwned: (cardIds: string[]) => void;
  clearAll: () => void;

  // Settings
  updateSettings: (settings: Partial<CollectionSettings>) => void;

  // Export/Import
  exportCollection: () => CollectionExport;
  importCollection: (data: CollectionExport, mode: 'merge' | 'replace') => void;
}
```

**Key behaviours:**
- State is keyed by `sourceId` so each collection has separate ownership data
- Use `persist` middleware with localStorage
- Handle Map serialisation for persistence

---

### 5. Card Overlay (CollectionCardOverlay.tsx)

Shows ownership badge on each card:

```
┌─────────────────┐
│            [✓]  │  ← Owned badge (checkmark)
│   [Image]       │
│                 │
│   Title         │
└─────────────────┘

┌─────────────────┐
│            [♡]  │  ← Wishlist badge (heart)
│   [Image]       │
│                 │
│   Title         │
└─────────────────┘

┌─────────────────┐
│            [+]  │  ← Not owned (plus, optional)
│   [Image]       │
│                 │
│   Title         │
└─────────────────┘
```

**Badge positioning:** Top-right corner, similar to existing card overlays.

**Click behaviour:** Cycle through states:
```
Not Owned → Owned → Wishlist → Not Owned
```

---

### 6. Grid Overlay (CollectionGridOverlay.tsx)

Shows collection progress at top of grid:

```
┌─────────────────────────────────────────────────────────────┐
│  Collection Progress                              [Export]  │
│  ████████████░░░░░░░░░░░░  45/100 (45%)                     │
│                                                             │
│  Owned: 45    Wishlist: 12    Remaining: 43                 │
└─────────────────────────────────────────────────────────────┘
```

**Components:**
- Progress bar (CSS-only, using `--percentage` custom property)
- Count breakdown
- Export button

---

### 7. Settings (Settings.tsx)

```typescript
interface CollectionSettingsProps {
  settings: CollectionSettings;
  onChange: (settings: Partial<CollectionSettings>) => void;
  disabled?: boolean;
}
```

**Settings options:**
- Show progress bar: Toggle
- Show badge on unowned cards: Toggle
- Keyboard shortcuts: Toggle

---

### 8. Export/Import (CollectionExport.tsx)

**Export:**
- Button in grid overlay opens export modal
- Downloads JSON file: `collection-{sourceId}-{date}.json`

**Import:**
- File picker for JSON
- Options: Merge (add to existing) or Replace (overwrite)
- Validation of import format

---

### 9. Keyboard Shortcuts

When mechanic is active and a card is focused:
- `O` - Toggle owned status
- `W` - Toggle wishlist status

Implement in card actions handler, respecting `settings.keyboardShortcuts`.

---

### 10. Mechanic Entry Point (index.tsx)

```typescript
import type { Mechanic, MechanicFactory } from '../types';
import { useCollectionStore } from './store';
import { CollectionCardOverlay } from './components/CollectionCardOverlay';
import { CollectionGridOverlay } from './components/CollectionGridOverlay';
import { CollectionSettings } from './Settings';
import manifest from './manifest.json';
import CollectionIcon from './CollectionIcon';

export const createCollectionMechanic: MechanicFactory = async () => {
  const mechanic: Mechanic<CollectionSettings> = {
    manifest: {
      ...manifest,
      icon: CollectionIcon,
    },

    lifecycle: {
      onActivate: () => {
        // Get current source ID and activate
        const sourceId = getCurrentSourceId();
        useCollectionStore.getState().activate(sourceId);
      },
      onDeactivate: () => {
        useCollectionStore.getState().deactivate();
      },
      onReset: () => {
        // Optional: clear current collection
      },
    },

    getState: () => useCollectionStore.getState(),
    subscribe: useCollectionStore.subscribe,

    getCardActions: () => ({
      onClick: (cardId) => {
        // Cycle ownership on click
        const store = useCollectionStore.getState();
        const status = store.getStatus(cardId);
        const next = status === 'none' ? 'owned'
                   : status === 'owned' ? 'wishlist'
                   : 'none';
        store.setOwnership(cardId, next);
      },
      canInteract: () => true,
      isHighlighted: (cardId) => {
        const status = useCollectionStore.getState().getStatus(cardId);
        return status !== 'none';
      },
    }),

    CardOverlay: CollectionCardOverlay,
    GridOverlay: CollectionGridOverlay,
    Settings: CollectionSettings,

    getSettings: () => useCollectionStore.getState().settings,
    setSettings: (settings) => useCollectionStore.getState().updateSettings(settings),
    defaultSettings: {
      showProgress: true,
      showUnownedBadge: false,
      keyboardShortcuts: true,
    },
  };

  return mechanic;
};
```

---

### 11. Registration

In `src/mechanics/index.ts`, add:

```typescript
import { createCollectionMechanic } from './collection';

mechanicRegistry.register('collection', createCollectionMechanic);
```

---

## Integration Points

### App.tsx / MechanicProvider
- No changes needed - uses existing mechanic context

### Card Component
- Uses existing `CardOverlay` prop pattern

### CardGrid
- Uses existing `GridOverlay` prop pattern

### localStorage
- New key: `itemdeck-collection-{version}`
- Persisted via Zustand `persist` middleware

---

## Testing Requirements

Create tests in `src/mechanics/collection/__tests__/`:

### Unit Tests

**store.test.ts:**
- Toggle owned status
- Toggle wishlist status
- Status cycling (none → owned → wishlist → none)
- Per-source isolation
- Persistence round-trip
- Export format validation
- Import merge mode
- Import replace mode

**types.test.ts:**
- Type guards if any

### Component Tests

**CollectionCardOverlay.test.tsx:**
- Renders correct badge for owned
- Renders correct badge for wishlist
- Renders no badge for unowned (unless setting enabled)
- Click cycles status

**CollectionGridOverlay.test.tsx:**
- Shows correct counts
- Progress bar percentage correct
- Export button opens modal

### Integration Tests

**collection.integration.test.tsx:**
- Full cycle: activate → mark owned → deactivate → reactivate (persisted)
- Export and import round-trip

---

## Success Criteria

- [ ] Mechanic appears in mechanics panel
- [ ] Can mark cards as owned
- [ ] Can mark cards as wishlisted
- [ ] Badges display correctly on cards
- [ ] Progress bar shows correct percentage
- [ ] State persists across sessions
- [ ] State is per-collection (different sources have separate data)
- [ ] Export produces valid JSON
- [ ] Import works in both merge and replace modes
- [ ] Keyboard shortcuts work (O, W)
- [ ] Settings toggle correctly
- [ ] All tests pass
- [ ] TypeScript strict mode compliant
- [ ] British English in all user-facing text

---

## Notes

- This is NOT a game mechanic - it's a persistent tracking tool
- State persists across sessions (unlike Memory/Snap Ranking)
- Each collection source has separate ownership data
- Consider future enhancement: sync across browsers (would require account system)

---

## Related Documentation

- [F-058 Feature Spec](../../../development/roadmap/features/planned/F-058-collection-mechanic.md)
- [Mechanic Types](../../../../src/mechanics/types.ts)
- [Memory Mechanic](../../../../src/mechanics/memory/) - Reference implementation
- [Snap Ranking Mechanic](../../../../src/mechanics/snap-ranking/) - Reference implementation
